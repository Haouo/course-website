
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lab4/">
      
      
        <link rel="next" href="../lab6/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.4">
    
    
      
        <title>Lab 5 - Single-Cycle CPU Design and Differential Testing - Computer Organization Fall 2024 @NCKUEE</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Lab 5 - Single-Cycle CPU Design and Differential Testing - Computer Organization Fall 2024 @NCKUEE" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="./assets/images/social/labs/lab5.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="None" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Lab 5 - Single-Cycle CPU Design and Differential Testing - Computer Organization Fall 2024 @NCKUEE" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="./assets/images/social/labs/lab5.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#from-isa-simulator-to-read-hardware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Computer Organization Fall 2024 @NCKUEE" class="md-header__button md-logo" aria-label="Computer Organization Fall 2024 @NCKUEE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Computer Organization Fall 2024 @NCKUEE
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 5 - Single-Cycle CPU Design and Differential Testing
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  首頁

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab_overview/" class="md-tabs__link">
          
  
  Lab material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../rtl/verilog/" class="md-tabs__link">
          
  
  RTL Programming

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tools/linux_cmd/" class="md-tabs__link">
          
  
  Tools Guide

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../references/" class="md-tabs__link">
        
  
    
  
  補充資料

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Computer Organization Fall 2024 @NCKUEE" class="md-nav__button md-logo" aria-label="Computer Organization Fall 2024 @NCKUEE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Computer Organization Fall 2024 @NCKUEE
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    首頁
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            首頁
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Lab material
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Lab material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 0 - How To Ask Questions The Smart Way
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 1 - C Programmin and Compilation Flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 2 - Simple RISC-V ISA Simulator with RV64I
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 3 - Bare-metal Runtime Environment and RISC-V Assembly Programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 4 - RTL Programming Review using SystemVerilog
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lab 5 - Single-Cycle CPU Design and Differential Testing
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lab 5 - Single-Cycle CPU Design and Differential Testing
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#from-isa-simulator-to-read-hardware" class="md-nav__link">
    <span class="md-ellipsis">
      From ISA Simulator to Read Hardware
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cpu-micro-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      CPU Micro-architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CPU Micro-architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-def" class="md-nav__link">
    <span class="md-ellipsis">
      Package - DEF
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-pc" class="md-nav__link">
    <span class="md-ellipsis">
      Module - PC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-regfile" class="md-nav__link">
    <span class="md-ellipsis">
      Module - RegFile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-immext" class="md-nav__link">
    <span class="md-ellipsis">
      Module - ImmExt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-alu" class="md-nav__link">
    <span class="md-ellipsis">
      Module - ALU
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-branchcomp" class="md-nav__link">
    <span class="md-ellipsis">
      Module - BranchComp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-ldfilte" class="md-nav__link">
    <span class="md-ellipsis">
      Module - LDFilte
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-controller" class="md-nav__link">
    <span class="md-ellipsis">
      Module - Controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Module - Memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-core" class="md-nav__link">
    <span class="md-ellipsis">
      Module - Core
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instruction-flow-beq" class="md-nav__link">
    <span class="md-ellipsis">
      Instruction Flow - 以 BEQ 指令為例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#topics-about-functional-verification-ie-before-synthesis" class="md-nav__link">
    <span class="md-ellipsis">
      Topics about Functional Verification (i.e., before synthesis)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Topics about Functional Verification (i.e., before synthesis)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#introduction-to-verilator" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction to Verilator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction to Verilator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-verilator-works" class="md-nav__link">
    <span class="md-ellipsis">
      How Verilator Works
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systemverilog-dpi-c-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      SystemVerilog DPI-C Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#softwarehardware-co-simulation-differential-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Software/Hardware Co-Simulation - Differential Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chapter-4-start-to-do-the-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      Chapter 4. Start to Do The Assignment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 4. Start to Do The Assignment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-assignment-requirement" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Assignment Requirement
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-notes" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 6 - Bus Protocol and Arbitration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 7 - Pipeline CPU and Simple Cache Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 8 - Deep Dive into Memory System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 9 - SIMD Accelerator and GEMM Kernel Design
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    RTL Programming
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            RTL Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rtl/verilog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to Verilog and RTL Programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rtl/sv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    From Verilog to SystemVerilog for Hardware Designing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rtl/sva/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SystemVerilog Assertion (SVA)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rtl/chisel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chisel HDL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tools Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tools Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/linux_cmd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic Linux Command
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/git_cmd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/markdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Markdown Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/gitlab_ov/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gitla & Mattermost
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/cli_tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Useful CLI Tools
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    補充資料
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Lab 5 - Single-Cycle CPU Design and Differential Testing</h1>

<div class="admonition info">
<p class="admonition-title">Update information</p>
<ul>
<li>Contributor：TA 峻豪</li>
<li>Last update：2024/12/13</li>
</ul>
</div>
<h2 id="from-isa-simulator-to-read-hardware">From ISA Simulator to Read Hardware<a class="headerlink" href="#from-isa-simulator-to-read-hardware" title="Permanent link">&para;</a></h2>
<p>在 Lab 2 中，我們透過 C 語言實作了一個 <em>ISA Simulator</em>，讓我們可以透過軟題來模擬指令集的層級的行為，屬於 Architecture Level 的探索。
但是，在這個 Lab 中，我們的目標是實作出一個實際的電路，而這個電路的功能是可以解析 RV64I 的指令並且執行對應的功能，因此我們必須思考怎麼樣的電路才能達成這個任務。</p>
<p>我們必須轉換我們的思維，在設計 ISS 的時候，我們的 design granularity 是 <strong><em>instruction-accurate</em></strong>，但是在實際的數位電路中，電路是由時鐘訊號（clock）驅動，因此我們的電路的 design granularity 會是 <strong><em>clock-accurate</em></strong>。
而在 Lab 5 中，我們的目標是實作 Single-Cycle CPU，Single-Cycle 意指我們必須要一個週期內完成取指（Instruction Fetch）、解碼（Instruction Decode）、執行（Execute）和寫回（Write-back）。</p>
<div class="admonition note">
<p class="admonition-title">Single-Cycle 的侷限性</p>
<p>大家仔細思考後應該可以發現，只要今天我們所實作的 CPU 讀取的記憶體，不論是 Instruction Memory 還是 Data Memory，如果它們無法在一個 Cycle 完成 Data Access，那麼我們的 Single-Cycle CPU 就會失效。
如果我們今天所需的記憶體大小不大，我們或許可以直接使用一個小型的 Register Array 或是 FPGA 版上的 DUTRAM，那麼就可以支援 <strong>Asynchronous Read</strong>。
但是，假設今天我們需要大一點的記憶體空間，可能就會需要用到真正專門的 Memory Element，譬如 FPGA 版上的 Block RAM (BRAM) 或甚至是外接 SD Card (Flash Memory)，這種記憶體就會是 <strong>Synchronous Read</strong>，
至少需要兩個 clock cycle 才能拿到 read data（當前 cycle 傳入 address，下個 cycle 拿到資料）。</p>
<p>遇到這種狀況的時候，我們可能就會需要將 Single-Cycle CPU 轉變為 Multi-Cycle CPU，才能夠應對 memory system 的 read/write latency，況且有時候 latency 甚至是不固定的！</p>
</div>
<h2 id="cpu-micro-architecture">CPU Micro-architecture<a class="headerlink" href="#cpu-micro-architecture" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Architecture vs. Micro-architecture</p>
<p><strong>一個 Architecture (ISA) 可能會對應到多種可能的 Micro-architecture implementation</strong></p>
<p>對於軟體工程師來說，通常他們所能接觸到關於整個計算機的細節的最底層就會是 ISA（暫時不討論關於 Performance Optimization），對於軟體工程師來說，他們只需要知道 CPU 支援哪些指令，他們就可以在這個平台之上去建構各式各樣的軟體。
而對於設計 CPU 的工程師來說，他們大多時候能夠接觸到的關於系統中最上層的細節也會是 ISA（一樣不討論 Performance Optimization），他們不必須要知道這個 CPU 未來可能會被拿來執行哪些程式，他們只需要根據 ISA 手冊的規範將功能完整地實現就好。</p>
<p><strong>為什麼說暫時不討論 Performance Optimization？</strong></p>
<p>通常現實系統的開發往往會複雜很多，對於軟體工程師來說，如果要針對軟體效能做激進地優化，通常他們會需要知道 CPU 的 micro-architecture 細節，如 Cache Size，如此一來才可以設計出更佳 cache-friendly 的軟體，使效能更好。
而對於 CPU Architect 來說，他們往往不會被侷限在 ISA-Level 底下，他們也會需要知道這個 CPU 未來可能會被拿來執行哪些程式（又稱為 <font color="red"><strong>workload</strong></font>），他們需要做 workload analysis，並且根據分析後的結果，去調整 micro-architecture，目標也是為了讓 workload 在 CPU 上執行的效能更好。</p>
<p>大家對這方面的議題感興趣的話，可以閱讀這篇文章：<a href="https://furuame.blogspot.com/2024/04/four-years-at-sifive.html#more">我在 SiFive 處理器架構部門四年的經歷 by Zen</a>。</p>
</div>
<p>我們實作的 CPU 的微架構（micro-architecture）如下圖所示（可以右鍵點 <u>用新分頁開啟圖片</u> 看更大張的圖）</p>
<figure>
  <img alt="" src="../img/lab-5/diagram.png" />
</figure>
<p>我們分別探討 Single-Cycle CPU 中的每個 Module 的功能是什麼</p>
<h3 id="package-def">Package - DEF<a class="headerlink" href="#package-def" title="Permanent link">&para;</a></h3>
<p>首先，借助 SystemVerilog 相對於 Verilog 更強大的抽象能力，我們定義了一個 package <code>DEF</code>，裡面包含了我們需要用到的一些 data types。</p>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">DEF.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">  1</a></span>
<span class="normal"><a href="#__codelineno-0-2">  2</a></span>
<span class="normal"><a href="#__codelineno-0-3">  3</a></span>
<span class="normal"><a href="#__codelineno-0-4">  4</a></span>
<span class="normal"><a href="#__codelineno-0-5">  5</a></span>
<span class="normal"><a href="#__codelineno-0-6">  6</a></span>
<span class="normal"><a href="#__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">package</span> <span class="n">DEF</span><span class="p">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="cm">/* define width of double-word */</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dw</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span><span class="n">SEL_PC_PLUS_4</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span><span class="n">SEL_LOAD_DATA</span><span class="p">,</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">        </span><span class="n">SEL_ALU_OUT</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">wb_sel_t</span><span class="p">;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="cm">/* RISC-V RV64I instruction formats (equivalent to 32-bit logic type) */</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="n">union</span><span class="w"> </span><span class="k">packed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="c1">// R-type</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="k">packed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">opcode</span><span class="p">;</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">func3</span><span class="p">;</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs1</span><span class="p">;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs2</span><span class="p">;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">func7</span><span class="p">;</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">R_TYPE</span><span class="p">;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">        </span><span class="c1">// I-type</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="k">packed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">opcode</span><span class="p">;</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">rd</span><span class="p">;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">func3</span><span class="p">;</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">rs1</span><span class="p">;</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm_11_0</span><span class="p">;</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">I_TYPE</span><span class="p">;</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">        </span><span class="c1">// S-type</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="k">packed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">opcode</span><span class="p">;</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm_4_0</span><span class="p">;</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">func3</span><span class="p">;</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs1</span><span class="p">;</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs2</span><span class="p">;</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm_11_5</span><span class="p">;</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">S_TYPE</span><span class="p">;</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">        </span><span class="c1">// U-type</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="k">packed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">opcode</span><span class="p">;</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">rd</span><span class="p">;</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm_31_12</span><span class="p">;</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">U_TYPE</span><span class="p">;</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">        </span><span class="c1">// B-type</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="k">packed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">opcode</span><span class="p">;</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="n">imm_11</span><span class="p">;</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm_4_1</span><span class="p">;</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">func3</span><span class="p">;</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs1</span><span class="p">;</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs2</span><span class="p">;</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm_10_5</span><span class="p">;</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="n">imm_12</span><span class="p">;</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">B_TYPE</span><span class="p">;</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">        </span><span class="c1">// J-type</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="k">packed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">opcode</span><span class="p">;</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm_19_12</span><span class="p">;</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="n">imm_11</span><span class="p">;</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">9</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm_10_1</span><span class="p">;</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="w">            </span><span class="kt">logic</span><span class="w"> </span><span class="n">imm_20</span><span class="p">;</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="n">J_TYPE</span><span class="p">;</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="w">        </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">raw</span><span class="p">;</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">inst_t</span><span class="p">;</span>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69"></a>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="w">    </span><span class="cm">/* instruction opcode map */</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="w">        </span><span class="n">OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0110011</span><span class="p">,</span>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="w">        </span><span class="n">OP_32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0111011</span><span class="p">,</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">        </span><span class="n">OP_IMM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0010011</span><span class="p">,</span>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="w">        </span><span class="n">OP_IMM_32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0011011</span><span class="p">,</span>
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="w">        </span><span class="n">LOAD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000011</span><span class="p">,</span>
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="w">        </span><span class="n">STORE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0100011</span><span class="p">,</span>
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="w">        </span><span class="n">BRANCH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b1100011</span><span class="p">,</span>
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">        </span><span class="n">JAL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b1101111</span><span class="p">,</span>
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="w">        </span><span class="n">JALR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b1100111</span><span class="p">,</span>
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="w">        </span><span class="n">AUIPC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0010111</span><span class="p">,</span>
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">        </span><span class="n">LUI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0110111</span><span class="p">,</span>
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">        </span><span class="n">SYSTEM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b1110011</span>
</span><span id="__span-0-84"><a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">INST_OPCODE</span><span class="p">;</span>
</span><span id="__span-0-85"><a id="__codelineno-0-85" name="__codelineno-0-85"></a>
</span><span id="__span-0-86"><a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="w">    </span><span class="cm">/* arithmetic func3 map */</span>
</span><span id="__span-0-87"><a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-88"><a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="w">        </span><span class="n">ADD_SUB_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">,</span>
</span><span id="__span-0-89"><a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="w">        </span><span class="n">SLL_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">,</span>
</span><span id="__span-0-90"><a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="w">        </span><span class="n">SLT_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">,</span>
</span><span id="__span-0-91"><a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="w">        </span><span class="n">SLTU_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="p">,</span>
</span><span id="__span-0-92"><a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="w">        </span><span class="n">XOR_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">,</span>
</span><span id="__span-0-93"><a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="w">        </span><span class="n">SRL_SRA_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">,</span>
</span><span id="__span-0-94"><a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="w">        </span><span class="n">OR_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="p">,</span>
</span><span id="__span-0-95"><a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">        </span><span class="n">AND_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b111</span>
</span><span id="__span-0-96"><a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">ARITHMETIC_FUNC3</span><span class="p">;</span>
</span><span id="__span-0-97"><a id="__codelineno-0-97" name="__codelineno-0-97"></a>
</span><span id="__span-0-98"><a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="w">    </span><span class="cm">/* branch inst. func3 map */</span>
</span><span id="__span-0-99"><a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-100"><a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="w">        </span><span class="n">BEQ_FUNC3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">,</span>
</span><span id="__span-0-101"><a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="w">        </span><span class="n">BNE_FUNC3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">,</span>
</span><span id="__span-0-102"><a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="w">        </span><span class="n">BLT_FUNC3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">,</span>
</span><span id="__span-0-103"><a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="w">        </span><span class="n">BGE_FUNC3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">,</span>
</span><span id="__span-0-104"><a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="w">        </span><span class="n">BLTU_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="p">,</span>
</span><span id="__span-0-105"><a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="w">        </span><span class="n">BGEU_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b111</span>
</span><span id="__span-0-106"><a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">BRANCH_FUNC3</span><span class="p">;</span>
</span><span id="__span-0-107"><a id="__codelineno-0-107" name="__codelineno-0-107"></a>
</span><span id="__span-0-108"><a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-109"><a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="w">        </span><span class="n">SB_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">,</span>
</span><span id="__span-0-110"><a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="w">        </span><span class="n">SH_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">,</span>
</span><span id="__span-0-111"><a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="w">        </span><span class="n">SW_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">,</span>
</span><span id="__span-0-112"><a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="w">        </span><span class="n">SD_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b011</span>
</span><span id="__span-0-113"><a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">STORE_FUNC3</span><span class="p">;</span>
</span><span id="__span-0-114"><a id="__codelineno-0-114" name="__codelineno-0-114"></a>
</span><span id="__span-0-115"><a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-116"><a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="w">        </span><span class="n">LB_FUNC3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">,</span>
</span><span id="__span-0-117"><a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="w">        </span><span class="n">LH_FUNC3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">,</span>
</span><span id="__span-0-118"><a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="w">        </span><span class="n">LW_FUNC3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">,</span>
</span><span id="__span-0-119"><a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="w">        </span><span class="n">LD_FUNC3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="p">,</span>
</span><span id="__span-0-120"><a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="w">        </span><span class="n">LBU_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">,</span>
</span><span id="__span-0-121"><a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="w">        </span><span class="n">LHU_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">,</span>
</span><span id="__span-0-122"><a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="w">        </span><span class="n">LWU_FUNC3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b110</span>
</span><span id="__span-0-123"><a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">LOAD_FUNC3</span><span class="p">;</span>
</span><span id="__span-0-124"><a id="__codelineno-0-124" name="__codelineno-0-124"></a>
</span><span id="__span-0-125"><a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-126"><a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="w">        </span><span class="n">ECALL_FUNC12</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">12</span><span class="mb">&#39;b000000000000</span><span class="p">,</span>
</span><span id="__span-0-127"><a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="w">        </span><span class="n">EBREAK_FUNC12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">12</span><span class="mb">&#39;b000000000001</span>
</span><span id="__span-0-128"><a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">SYSTEM_FUNC12</span><span class="p">;</span>
</span><span id="__span-0-129"><a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="k">endpackage</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">DEF</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="module-pc">Module - PC<a class="headerlink" href="#module-pc" title="Permanent link">&para;</a></h3>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">PC.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">module</span><span class="w"> </span><span class="n">PC</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::*</span><span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="p">(</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">next_pc</span><span class="p">,</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">current_pc</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="p">);</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="k">always_ff</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">            </span><span class="n">current_pc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">            </span><span class="n">current_pc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">next_pc</span><span class="p">;</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="k">endmodule</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PC</span>
</span></code></pre></div></td></tr></table></div>
<p>PC 這個 module 的功能只有一個，就是記錄著目前正在執行的指令的 memory address，也就是 Program Counter，並且在每個 Positive Edge 的時候更新 PC，將 <code>current_pc</code> 的值更新為輸入訊號 <code>next_pc</code>。</p>
<p>在模擬的最一開始，Testbench 會打入一個 asynchronous reset 訊號，並且我們的 PC 為 <strong>asynchronous active-low reset</strong>，而 PC 則會在這個時候被初始化成 0。</p>
<div class="admonition note">
<p class="admonition-title">Synchronous vs. Asynchronous Reset 之爭</p>
<p>大家對這個議題有興趣的話可以閱讀這兩篇論文，並且搜尋 <em>Reset Synchronizer</em></p>
<ol>
<li><a href="http://www.sunburst-design.com/papers/CummingsSNUG2002SJ_Resets.pdf">Synchronous Resets? Asynchronous Resets? I am so confused! How will I ever know which to use?</a></li>
<li><a href="http://www.sunburst-design.com/papers/CummingsSNUG2003Boston_Resets.pdf">Asynchronous &amp; Synchronous Reset Design Techniques - Part Deux</a></li>
</ol>
</div>
<h3 id="module-regfile">Module - RegFile<a class="headerlink" href="#module-regfile" title="Permanent link">&para;</a></h3>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">RegFile.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">module</span><span class="w"> </span><span class="n">RegFile</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::*</span><span class="p">;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="p">(</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs1_index</span><span class="p">,</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs2_index</span><span class="p">,</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">w_en</span><span class="p">,</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rd_index</span><span class="p">,</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">rd_data</span><span class="p">,</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">,</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">rs2_data</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="p">);</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="n">dw</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="mh">32</span><span class="p">];</span><span class="w">  </span><span class="c1">// register file</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="k">always_ff</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">32</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">                </span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rd_index</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">w_en</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">                </span><span class="n">mem</span><span class="p">[</span><span class="n">rd_index</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rd_data</span><span class="p">;</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">    </span><span class="cm">/* assign output read data */</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">rs1_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="n">rs1_index</span><span class="p">];</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">rs2_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="n">rs2_index</span><span class="p">];</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="k">endmodule</span>
</span></code></pre></div></td></tr></table></div>
<p>RegFile 這個 module 最主要的功能就是作為 RISC-V CPU 中的 32 個 General Purpose Register (GPR)，</p>
<h3 id="module-immext">Module - ImmExt<a class="headerlink" href="#module-immext" title="Permanent link">&para;</a></h3>
<p>因為在計算的過程中，我們有可能會用到 Immediate 作為其中一個運算元（operand），因此，我們需要有一個專門的硬體模組來產生目前指令所相對應的 Immediate，而在我們的設計中該模組稱為 <code>ImmExt</code>（Immediate Extender）。</p>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ImmExt.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span>
<span class="normal"><a href="#__codelineno-3-30">30</a></span>
<span class="normal"><a href="#__codelineno-3-31">31</a></span>
<span class="normal"><a href="#__codelineno-3-32">32</a></span>
<span class="normal"><a href="#__codelineno-3-33">33</a></span>
<span class="normal"><a href="#__codelineno-3-34">34</a></span>
<span class="normal"><a href="#__codelineno-3-35">35</a></span>
<span class="normal"><a href="#__codelineno-3-36">36</a></span>
<span class="normal"><a href="#__codelineno-3-37">37</a></span>
<span class="normal"><a href="#__codelineno-3-38">38</a></span>
<span class="normal"><a href="#__codelineno-3-39">39</a></span>
<span class="normal"><a href="#__codelineno-3-40">40</a></span>
<span class="normal"><a href="#__codelineno-3-41">41</a></span>
<span class="normal"><a href="#__codelineno-3-42">42</a></span>
<span class="normal"><a href="#__codelineno-3-43">43</a></span>
<span class="normal"><a href="#__codelineno-3-44">44</a></span>
<span class="normal"><a href="#__codelineno-3-45">45</a></span>
<span class="normal"><a href="#__codelineno-3-46">46</a></span>
<span class="normal"><a href="#__codelineno-3-47">47</a></span>
<span class="normal"><a href="#__codelineno-3-48">48</a></span>
<span class="normal"><a href="#__codelineno-3-49">49</a></span>
<span class="normal"><a href="#__codelineno-3-50">50</a></span>
<span class="normal"><a href="#__codelineno-3-51">51</a></span>
<span class="normal"><a href="#__codelineno-3-52">52</a></span>
<span class="normal"><a href="#__codelineno-3-53">53</a></span>
<span class="normal"><a href="#__codelineno-3-54">54</a></span>
<span class="normal"><a href="#__codelineno-3-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">module</span><span class="w"> </span><span class="n">ImmExt</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::*</span><span class="p">;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="p">(</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">inst_t</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">imm_ext_out</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="p">);</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">opcode</span><span class="p">;</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="n">dw</span><span class="w"> </span><span class="n">tmp_imm_ext_out</span><span class="p">;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="n">R_TYPE</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="k">always_comb</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">main_block</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">        </span><span class="n">unique</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OP</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OP_32</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SYSTEM</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">noimm</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">            </span><span class="cm">/* R-type and SYSTEM type */</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">            </span><span class="n">tmp_imm_ext_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">noimm</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JAL</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">jal</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">            </span><span class="cm">/* J-type */</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">            </span><span class="n">tmp_imm_ext_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">                </span><span class="p">{</span><span class="mh">44</span><span class="p">{</span><span class="n">inst</span><span class="p">.</span><span class="n">J_TYPE</span><span class="p">.</span><span class="n">imm_20</span><span class="p">}},</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">                </span><span class="n">inst</span><span class="p">.</span><span class="n">J_TYPE</span><span class="p">.</span><span class="n">imm_19_12</span><span class="p">,</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">                </span><span class="n">inst</span><span class="p">.</span><span class="n">J_TYPE</span><span class="p">.</span><span class="n">imm_11</span><span class="p">,</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">                </span><span class="n">inst</span><span class="p">.</span><span class="n">J_TYPE</span><span class="p">.</span><span class="n">imm_10_1</span><span class="p">,</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">                </span><span class="mh">1</span><span class="mb">&#39;b0</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">            </span><span class="p">};</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">jal</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">STORE</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">store</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">            </span><span class="cm">/* S-type */</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">            </span><span class="n">tmp_imm_ext_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">                </span><span class="p">{</span><span class="mh">52</span><span class="p">{</span><span class="n">inst</span><span class="p">.</span><span class="n">S_TYPE</span><span class="p">.</span><span class="n">imm_11_5</span><span class="p">[</span><span class="mh">6</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="n">S_TYPE</span><span class="p">.</span><span class="n">imm_11_5</span><span class="p">,</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="n">S_TYPE</span><span class="p">.</span><span class="n">imm_4_0</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">            </span><span class="p">};</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">store</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BRANCH</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">            </span><span class="cm">/* B-type */</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">            </span><span class="n">tmp_imm_ext_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="w">                </span><span class="p">{</span><span class="mh">52</span><span class="p">{</span><span class="n">inst</span><span class="p">.</span><span class="n">B_TYPE</span><span class="p">.</span><span class="n">imm_12</span><span class="p">}},</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">                </span><span class="n">inst</span><span class="p">.</span><span class="n">B_TYPE</span><span class="p">.</span><span class="n">imm_11</span><span class="p">,</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">                </span><span class="n">inst</span><span class="p">.</span><span class="n">B_TYPE</span><span class="p">.</span><span class="n">imm_10_5</span><span class="p">,</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39"></a><span class="w">                </span><span class="n">inst</span><span class="p">.</span><span class="n">B_TYPE</span><span class="p">.</span><span class="n">imm_4_1</span><span class="p">,</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">                </span><span class="mh">1</span><span class="mb">&#39;b0</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">            </span><span class="p">};</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">branch</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LUI</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AUIPC</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">u_type</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="w">            </span><span class="cm">/* U-type */</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="w">            </span><span class="n">tmp_imm_ext_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">32</span><span class="p">{</span><span class="n">inst</span><span class="p">.</span><span class="n">U_TYPE</span><span class="p">.</span><span class="n">imm_31_12</span><span class="p">[</span><span class="mh">19</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="n">U_TYPE</span><span class="p">.</span><span class="n">imm_31_12</span><span class="p">,</span><span class="w"> </span><span class="mh">12</span><span class="mb">&#39;b0</span><span class="p">};</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">u_type</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">i_type</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="w">            </span><span class="cm">/* I-type */</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">            </span><span class="cm">/* includes OP_IMM, OP_IMM_32, LOAD, JALR*/</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="w">            </span><span class="n">tmp_imm_ext_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">52</span><span class="p">{</span><span class="n">inst</span><span class="p">.</span><span class="n">I_TYPE</span><span class="p">.</span><span class="n">imm_11_0</span><span class="p">[</span><span class="mh">11</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="n">I_TYPE</span><span class="p">.</span><span class="n">imm_11_0</span><span class="p">};</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">i_type</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52"></a><span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">main_block</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53"></a>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">imm_ext_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp_imm_ext_out</span><span class="p">;</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="k">endmodule</span>
</span></code></pre></div></td></tr></table></div>
<p>ImmExt 這個模組的主要功能就是根據目前指令的 format type 來產生對應的 sign-extended immediate，以便後面 ALU 做運算的時候可以使用。
大家可以發現當我們事先在 <code>DEF.sv</code> 中利用 <code>union packed</code> 配合 <code>struct packed</code> 去定義好六種不同的指令格式的 Bit-Field 之後，我們在 ImmExt 的實作中就可以利用 Bit-Field 來讓程式碼的<strong>可讀性</strong>更高。</p>
<p>除此之外，所有和指令格式相關的程式碼，只要我們都可以確實利用已經在 <code>DEF.sv</code> 中定義好的 Bit-Field 的話，即使我們在之後發現我們的 Bit-Field 定義有誤，
或甚至是 Spec 有更動（當然機率極低），就只需要更改 <code>DEF.sv</code> 中的程式碼即可，不用把所有相關的程式碼都修改一遍，可以大幅提高<strong>可維護性</strong>。</p>
<h3 id="module-alu">Module - ALU<a class="headerlink" href="#module-alu" title="Permanent link">&para;</a></h3>
<p>因為我們實作的指令集 RV64I 中包含了一般操作在 64-bit operand 上的指令，還有以 W 為後綴（suffix），只操作在 64-bit operand 的 lower 32-bit 的指令。
因此我們的 ALU 需要同時支援這兩種運算。我們針對 ALU 的控制訊號做了高度的抽象，讓我們的程式碼可讀性更高。</p>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Part of DEF.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="cm">/* opcode enumeration of ALU */</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="n">ALU_OP_ADD</span><span class="p">,</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="n">ALU_OP_SLL</span><span class="p">,</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">ALU_OP_SLT</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">ALU_OP_SLTU</span><span class="p">,</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="n">ALU_OP_XOR</span><span class="p">,</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="n">ALU_OP_SRL</span><span class="p">,</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="n">ALU_OP_OR</span><span class="p">,</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="n">ALU_OP_AND</span><span class="p">,</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="n">ALU_OP_SUB</span><span class="p">,</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="n">ALU_OP_SRA</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="p">}</span><span class="w"> </span><span class="n">alu_opcode_t</span><span class="p">;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="n">ALU_OP_32</span><span class="p">,</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="n">ALU_OP_64</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="p">}</span><span class="w"> </span><span class="n">alu_op_width_t</span><span class="p">;</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="k">packed</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">    </span><span class="n">alu_opcode_t</span><span class="w">   </span><span class="n">alu_op</span><span class="p">;</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">    </span><span class="n">alu_op_width_t</span><span class="w"> </span><span class="n">alu_width</span><span class="p">;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="p">}</span><span class="w"> </span><span class="n">alu_control_packet_t</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>我們利用 enum 來枚舉 ALU 必須支援的運算類型還有寬度（Data Width），然後再利用 struct 把 <code>alu_opcode_t</code> 和 <code>alu_op_width_t</code> 包裝起來變成 <code>alu_control_packet_t</code>。</p>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ALU.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">module</span><span class="w"> </span><span class="n">ALU</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::*</span><span class="p">;</span><span class="w">  </span><span class="c1">// import package DEF in module header</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="p">(</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">alu_control_packet_t</span><span class="w"> </span><span class="n">alu_control</span><span class="p">,</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">operand_1</span><span class="p">,</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">operand_2</span><span class="p">,</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">alu_out</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="p">);</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="c1">// TODO</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="k">endmodule</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALU</span>
</span></code></pre></div></td></tr></table></div>
<p>在 <code>ALU.sv</code> 中，我們要完成 ALU 實作。舉體來說，我們必須根據由 Controller 產生的控制訊號 <code>alu_control</code> 來決定該執行哪種類型的運算。
舉例來說，我們可以用以下的形式來描述 ALU 的行為（behhavior modeling）。</p>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Example of implementing ALU addition</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">function</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">twos_complement</span><span class="p">(</span><span class="n">dw</span><span class="w"> </span><span class="k">input</span><span class="p">);</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="k">input</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d1</span><span class="p">);</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="k">endfunction</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">twos_complement</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="n">dw</span><span class="w"> </span><span class="n">pre_calaulate</span><span class="p">;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="k">always_comb</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="n">unique</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">alu_control</span><span class="p">.</span><span class="n">alu_op</span><span class="p">)</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">        </span><span class="nl">ALU_OP_ADD:</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">            </span><span class="n">pre_calculate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operand_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">operand_2</span><span class="p">;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">        </span><span class="nl">ALU_OP_SUB:</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">            </span><span class="n">pre_calculate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operand_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">twos_complement</span><span class="p">(</span><span class="n">operand_2</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">        </span><span class="c1">// TODO: add more branches for this case statement to make the ALU complete</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">    </span><span class="k">endcase</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="k">end</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="k">assign</span><span class="w"> </span><span class="n">alu_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">alu_control</span><span class="p">.</span><span class="n">alu_width</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ALU_OP_64</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">pre_calculate</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{{</span><span class="mh">32</span><span class="p">{</span><span class="n">pre_calculate</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">pre_calculate</span><span class="p">};</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="module-branchcomp">Module - BranchComp<a class="headerlink" href="#module-branchcomp" title="Permanent link">&para;</a></h3>
<p>當我們執行到 BRANCH 指令的時候（e.g., BEQ, BLT, ...），我們會需要<strong>同時</strong>處理兩個運算問題</p>
<ol>
<li>比較 rs1 和 rs2<ul>
<li>BEQ<blockquote>
<p><span class="arithmatex">\(\text{rs1} = \text{rs2}\)</span> (sign is not important)</p>
</blockquote>
</li>
<li>BNE<blockquote>
<p><span class="arithmatex">\(\text{rs1} \neq \text{rs2}\)</span> (sign is not important)</p>
</blockquote>
</li>
<li>BLT<blockquote>
<p><span class="arithmatex">\(\text{rs1}_{\text{signed}} &lt; \text{rs2}_{\text{signed}}\)</span></p>
</blockquote>
</li>
<li>BLTU<blockquote>
<p><span class="arithmatex">\(\text{rs1}_{\text{signed}} \ge \text{rs2}_{\text{signed}}\)</span></p>
</blockquote>
</li>
<li>BGE<blockquote>
<p><span class="arithmatex">\(\text{rs1}_{\text{unsigned}} &lt; \text{rs2}_{\text{unsigned}}\)</span></p>
</blockquote>
</li>
<li>BGEU<blockquote>
<p><span class="arithmatex">\(\text{rs1}_{\text{unsigned}} \ge \text{rs2}_{\text{unsigned}}\)</span></p>
</blockquote>
</li>
</ul>
</li>
<li>計算 Branch Target Address<br><ul>
<li><span class="arithmatex">\(\text{PC} + \text{offset}\)</span></li>
</ul>
</li>
</ol>
<p>如果以我們目前的 ALU 設計，只能同時輸入兩個 operands 並且執行一種運算，如此一來當我們要處理 BRANCH 指令的時候就會發生 <strong>structural Hazard</strong>。
所以除了有 ALU 以外，我們必須引入一個新的 module 叫做 Branch Comparator (BranchComp)，這個 module 用來處理 BRANCH 相關的<strong>比較運算</strong>，並且給出 Branch Result。</p>
<p>BranchComp 和 Controller 之間會有三個控制訊號，<code>BrUn</code> 由 Controller 產生，用來指示 BranchComp 應該要把 rs1 和 rs2 視為 signed 還是 unsigned，而 <code>BrEq</code> 和 <code>BrLt</code> 則由 BranchComp 產生，
用來告訴 Controller 比較運算的結果，讓 Controller 可以由 <code>BrEq</code> 和 <code>BrLt</code> 配合目前的 BRANCH 指令類型來判斷 Branch 是 Taken 還是 Not-taken。</p>
<div class="admonition note">
<p class="admonition-title">Example Case</p>
<p>舉例來說，假設目前執行的指令是 BGEU，則 Controller 應產生 <code>BrUn</code> 為 <code>1'b1</code>，而 BranchComp 則因此執行 unsigned comparasion。
假設 rs1 為 <code>64'FFFFFFFFFFFFFF12</code>，而 rs2 為 <code>64'h0000000000000022</code>，則應產生 <code>BrEq</code> 為 <code>1'b0</code> 且 <code>BrLt</code> 為 <code>1'b0</code>。
Controller 則根據目前指令為 BGEU 且 <code>BrLt</code> 為 <code>1'b0</code> 得知目前的 Branch Result 為 Taken，所以下一個週期應該跳轉到 <span class="arithmatex">\(\text{PC} + \text{Offset}\)</span>。</p>
</div>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">intf.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span>
<span class="normal"><a href="#__codelineno-7-6">6</a></span>
<span class="normal"><a href="#__codelineno-7-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">interface</span><span class="w"> </span><span class="n">BranchCompControlIntf</span><span class="p">;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="cm">/* signal bundle */</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="kt">logic</span><span class="w"> </span><span class="n">BrUn</span><span class="p">,</span><span class="w"> </span><span class="n">BrEq</span><span class="p">,</span><span class="w"> </span><span class="n">BrLt</span><span class="p">;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="cm">/* modports */</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="n">modport</span><span class="w"> </span><span class="n">ControllerSide</span><span class="p">(</span><span class="k">output</span><span class="w"> </span><span class="n">BrUn</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">BrEq</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">BrLt</span><span class="p">);</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="n">modport</span><span class="w"> </span><span class="n">BranchCompSide</span><span class="p">(</span><span class="k">input</span><span class="w"> </span><span class="n">BrUn</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">BrEq</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">BrLt</span><span class="p">);</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="n">endinterface</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BranchCompControlIntf</span>
</span></code></pre></div></td></tr></table></div>
<p>我們利用 SystemVerilog 中的 interface 語法，將 Controller 和 BranchComp 之間的訊號連接封裝起來，並且利用 modport 語法來指令訊號的方向。</p>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">BranchComp.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">module</span><span class="w"> </span><span class="n">BranchComp</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::*</span><span class="p">;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="p">(</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">operand_1</span><span class="p">,</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">operand_2</span><span class="p">,</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="n">BranchCompControlIntf</span><span class="p">.</span><span class="n">BranchCompSide</span><span class="w"> </span><span class="n">control</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="p">);</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">control</span><span class="p">.</span><span class="n">BrEq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">operand_1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">operand_2</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="k">always_comb</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">control</span><span class="p">.</span><span class="n">BrUn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">            </span><span class="n">control</span><span class="p">.</span><span class="n">BrLt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">operand_1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">operand_2</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">            </span><span class="n">control</span><span class="p">.</span><span class="n">BrLt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">operand_1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">operand_2</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="k">endmodule</span>
</span></code></pre></div></td></tr></table></div>
<p>利用 interface 封裝訊號之後，我們在定義 <code>BranchComp</code> module 的時候，就可以直接用 <code>BranchCompControlIntf.BranchCompSide</code> 來宣告 Controller 和 BranchComp 之間的控制訊號。</p>
<h3 id="module-ldfilte">Module - LDFilte<a class="headerlink" href="#module-ldfilte" title="Permanent link">&para;</a></h3>
<p>我們的 CPU 支援的 LOAD 指令類型總共有七種，分別是 LB、LH、LW、LD、LBU、LHU 和 LWU，但是在我們的 Datapath 中，我們一次會直接從 Data Memory 中讀出 64-bit (double-word) 的數據，
因此，我們會需要一個特殊的 module 來對從 Data Memory 讀出的數據進行修改，以支援全部七種的 LOAD 指令類型，在這裡我們稱這個 module 為 <strong>LOAD Filter</strong> (LDFilter)。</p>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">LDFilter.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">module</span><span class="w"> </span><span class="n">LDFilter</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::*</span><span class="p">;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="p">(</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">func3</span><span class="p">,</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">in_data</span><span class="p">,</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">out_data</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="p">);</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="k">always_comb</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">        </span><span class="n">unique</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">func3</span><span class="p">)</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">            </span><span class="nl">LB_FUNC3:</span><span class="w">  </span><span class="n">out_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">56</span><span class="p">{</span><span class="n">in_data</span><span class="p">[</span><span class="mh">7</span><span class="p">]}},</span><span class="w"> </span><span class="n">in_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">            </span><span class="nl">LH_FUNC3:</span><span class="w">  </span><span class="n">out_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">48</span><span class="p">{</span><span class="n">in_data</span><span class="p">[</span><span class="mh">15</span><span class="p">]}},</span><span class="w"> </span><span class="n">in_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">            </span><span class="nl">LW_FUNC3:</span><span class="w">  </span><span class="n">out_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">32</span><span class="p">{</span><span class="n">in_data</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">in_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">            </span><span class="nl">LD_FUNC3:</span><span class="w">  </span><span class="n">out_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in_data</span><span class="p">;</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">            </span><span class="nl">LBU_FUNC3:</span><span class="w"> </span><span class="n">out_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">56</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">in_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">            </span><span class="nl">LHU_FUNC3:</span><span class="w"> </span><span class="n">out_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">48</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">in_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">            </span><span class="nl">LWU_FUNC3:</span><span class="w"> </span><span class="n">out_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">in_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">            </span><span class="k">default</span><span class="o">:</span><span class="w">   </span><span class="n">out_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">        </span><span class="k">endcase</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="k">endmodule</span>
</span></code></pre></div></td></tr></table></div>
<div class="admonition question">
<p class="admonition-title">The unique keyword</p>
<p>請思考為什麼在這裡我們會在 case statement 前面加上 <code>unique</code> 這個 keyword，對於 logic synthesis 有幫助嗎？
如果把 <code>unique</code> 改成 <code>priority</code> 的話你覺得合適嗎？</p>
</div>
<h3 id="module-controller">Module - Controller<a class="headerlink" href="#module-controller" title="Permanent link">&para;</a></h3>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Controller.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">module</span><span class="w"> </span><span class="n">Controller</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::*</span><span class="p">;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="p">(</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="cm">/* inst information */</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">inst_t</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="cm">/* a0 and a1 for ECALL handle */</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">reg_a0</span><span class="p">,</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">reg_a1</span><span class="p">,</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="cm">/* next PC select */</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">next_pc_sel_t</span><span class="w"> </span><span class="n">next_pc_sel</span><span class="p">,</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="cm">/* IM write control */</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">im_w_mask</span><span class="p">,</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="cm">/* Register File Control */</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">reg_w_en</span><span class="p">,</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">    </span><span class="cm">/* ALU control */</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">alu_op1_sel_t</span><span class="w"> </span><span class="n">alu_op1_sel</span><span class="p">,</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">alu_op2_sel_t</span><span class="w"> </span><span class="n">alu_op2_sel</span><span class="p">,</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">is_lui</span><span class="p">,</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">alu_control_packet_t</span><span class="w"> </span><span class="n">alu_control</span><span class="p">,</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">    </span><span class="cm">/* Branch Comparator control */</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">    </span><span class="n">BranchCompControlIntf</span><span class="p">.</span><span class="n">ControllerSide</span><span class="w"> </span><span class="n">bc_control</span><span class="p">,</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">    </span><span class="cm">/* DM write control */</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dm_w_mask</span><span class="p">,</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">    </span><span class="cm">/* write-back select */</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">wb_sel_t</span><span class="w"> </span><span class="n">wb_sel</span><span class="p">,</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">    </span><span class="cm">/* halt signal (for testbench to monitor) */</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">halt</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="p">);</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="w">    </span><span class="c1">// TODO: please implement Controller module</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30"></a>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">    </span><span class="cm">/* ECALL handling */</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="w">    </span><span class="k">always_latch</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">I_TYPE</span><span class="p">.</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SYSTEM</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">inst</span><span class="p">.</span><span class="n">I_TYPE</span><span class="p">.</span><span class="n">imm_11_0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ECALL_FUNC12</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reg_a0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ECALL_to_halt</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="w">                </span><span class="n">halt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ECALL_to_halt</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reg_a0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ECALL_to_putchar</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="w">                </span><span class="nb">$display</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reg_a1</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]);</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ECALL_to_putchar</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ECALL_not_support</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="w">                </span><span class="nb">$display</span><span class="p">(</span><span class="s">&quot;Not supported ECALL service request type!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="w">                </span><span class="nb">$finish</span><span class="p">;</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43"></a><span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ECALL_not_support</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46"></a><span class="k">endmodule</span>
</span></code></pre></div></td></tr></table></div>
<p>Controller 幾乎可以說是整個 Single-Cycle CPU 中最重要的部分了，因為 Controller 負責產生各個 Module 和 Mux 的控制訊號，如果 Controller 無法正確地顫聲控制訊號的話，即使 Datapath 的設計沒問題，可能也會發生錯誤。</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>op\signals</strong></th>
<th style="text-align: center;"><code>next_pc_sel</code></th>
<th style="text-align: center;"><code>im_w_mask</code></th>
<th style="text-align: center;"><code>reg_w_en</code></th>
<th style="text-align: center;"><code>alu_op1_sel</code></th>
<th style="text-align: center;"><code>alu_op2_sel</code></th>
<th style="text-align: center;"><code>is_lui</code></th>
<th style="text-align: center;"><code>bc_control</code></th>
<th style="text-align: center;"><code>dm_w_mask</code></th>
<th style="text-align: center;"><code>wb_sel</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">OP</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">rs1</td>
<td style="text-align: center;">rs2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">alu_out</td>
</tr>
<tr>
<td style="text-align: center;">OP_32</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">rs1</td>
<td style="text-align: center;">rs2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">alu_out</td>
</tr>
<tr>
<td style="text-align: center;">OP_IMM</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">rs1</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">alu_out</td>
</tr>
<tr>
<td style="text-align: center;">OP_IMM_32</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">rs1</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">alu_out</td>
</tr>
<tr>
<td style="text-align: center;">LOAD</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">rs1</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Load data</td>
</tr>
<tr>
<td style="text-align: center;">STORE</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">rs1</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">Depends on STORE func3</td>
<td style="text-align: center;">X</td>
</tr>
<tr>
<td style="text-align: center;">BRANCH</td>
<td style="text-align: center;">Branch Target</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">PC</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Depends on BRANCH func3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
</tr>
<tr>
<td style="text-align: center;">JAL</td>
<td style="text-align: center;">Branch Target</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">PC</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">PC+4</td>
</tr>
<tr>
<td style="text-align: center;">JALR</td>
<td style="text-align: center;">Branch Target</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">rs1</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">PC+4</td>
</tr>
<tr>
<td style="text-align: center;">AUIPC</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">PC</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">alu_out</td>
</tr>
<tr>
<td style="text-align: center;">LUI</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">True</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">imm</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">alu_out</td>
</tr>
<tr>
<td style="text-align: center;">SYSTEM</td>
<td style="text-align: center;">PC+4</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">False</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">X</td>
</tr>
</tbody>
</table>
<p>至於 <code>clu_control</code> 的部分因為比較複雜，我們獨立出來分析</p>
<div align="center">
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>op-type\signals</strong></th>
<th style="text-align: center;"><code>alu_op</code></th>
<th style="text-align: center;"><code>alu_width</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">OP</td>
<td style="text-align: center;">?</td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">OP_32</td>
<td style="text-align: center;">?</td>
<td style="text-align: center;"><code>ALU_OP_32</code></td>
</tr>
<tr>
<td style="text-align: center;">OP_IMM</td>
<td style="text-align: center;">?</td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">OP_IMM_32</td>
<td style="text-align: center;">?</td>
<td style="text-align: center;"><code>ALU_OP_32</code></td>
</tr>
<tr>
<td style="text-align: center;">LOAD</td>
<td style="text-align: center;"><code>ALU_OP_ADD</code></td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">STORE</td>
<td style="text-align: center;"><code>ALU_OP_ADD</code></td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">BRANCH</td>
<td style="text-align: center;"><code>ALU_OP_ADD</code></td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">JAL</td>
<td style="text-align: center;"><code>ALU_OP_ADD</code></td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">JALR</td>
<td style="text-align: center;"><code>ALU_OP_ADD</code></td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">AUIPC</td>
<td style="text-align: center;"><code>ALU_OP_ADD</code></td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">LUI</td>
<td style="text-align: center;"><code>ALU_OP_ADD</code></td>
<td style="text-align: center;"><code>ALU_OP_64</code></td>
</tr>
<tr>
<td style="text-align: center;">SYSTEM</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">X</td>
</tr>
</tbody>
</table>
</div>
<h3 id="module-memory">Module - Memory<a class="headerlink" href="#module-memory" title="Permanent link">&para;</a></h3>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Memory.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">module</span><span class="w"> </span><span class="n">Memory</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::</span><span class="n">dw</span><span class="p">;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="p">(</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">w_mask</span><span class="p">,</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">dw</span><span class="w"> </span><span class="n">read_data</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="p">);</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="mh">65536</span><span class="p">];</span><span class="w">  </span><span class="c1">// register array to mimic DRAM</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="cm">/* main memory logic */</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">    </span><span class="k">always_ff</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">        </span><span class="n">unique0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_mask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b11111111</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">                </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">8</span><span class="o">*</span><span class="n">i</span><span class="o">+:</span><span class="mh">8</span><span class="p">];</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_mask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b00001111</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">logic</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">                </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">8</span><span class="o">*</span><span class="n">i</span><span class="o">+:</span><span class="mh">8</span><span class="p">];</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">            </span><span class="k">end</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_mask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b00000011</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">            </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">0</span><span class="o">+:</span><span class="mh">8</span><span class="p">];</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">            </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">8</span><span class="o">+:</span><span class="mh">8</span><span class="p">];</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_mask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b00000001</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="w">            </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">0</span><span class="o">+:</span><span class="mh">8</span><span class="p">];</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">        </span><span class="k">end</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="w">    </span><span class="cm">/* assign output read data */</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="mh">7</span><span class="p">],</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32"></a><span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="mh">6</span><span class="p">],</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="mh">5</span><span class="p">],</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="mh">4</span><span class="p">],</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="mh">3</span><span class="p">],</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="mh">2</span><span class="p">],</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="o">+</span><span class="mh">1</span><span class="p">],</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38"></a><span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40"></a><span class="k">endmodule</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="module-core">Module - Core<a class="headerlink" href="#module-core" title="Permanent link">&para;</a></h3>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Core.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span>
<span class="normal"><a href="#__codelineno-12-7">7</a></span>
<span class="normal"><a href="#__codelineno-12-8">8</a></span>
<span class="normal"><a href="#__codelineno-12-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">module</span><span class="w"> </span><span class="n">Core</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="n">import</span><span class="w"> </span><span class="n">DEF</span><span class="o">::*</span><span class="p">;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="p">(</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">logic</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">logic</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">logic</span><span class="w"> </span><span class="n">halt</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="p">);</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="c1">// module instantiate and wire connect...</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="k">endmodule</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Core</span>
</span></code></pre></div></td></tr></table></div>
<p>基本上 Core 這個 module 就是將 Datapath 中各個 components（包含 Controller）實例化，然後將將他們連接起來。
有一點要特別注意的是，在 CPU Block Diagram 中，有些多工器（Mux）我們是在 Core module 中才實作。</p>
<h3 id="instruction-flow-beq">Instruction Flow - 以 BEQ 指令為例<a class="headerlink" href="#instruction-flow-beq" title="Permanent link">&para;</a></h3>
<p>TBD</p>
<h2 id="topics-about-functional-verification-ie-before-synthesis">Topics about Functional Verification (i.e., before synthesis)<a class="headerlink" href="#topics-about-functional-verification-ie-before-synthesis" title="Permanent link">&para;</a></h2>
<h3 id="introduction-to-verilator">Introduction to Verilator<a class="headerlink" href="#introduction-to-verilator" title="Permanent link">&para;</a></h3>
<p>相較於 Verilator，大家應該更常聽到 Synopsys VCS 或是 Cadence XCELIUM 這兩個商業用的 Simulator，他們都可以用來模擬並且驗證我們設計的電路。
但是這兩個工具的缺點就是非常昂貴啊！是因為我們在台灣有 TSRI 的幫忙，在學校裡面才可以免費使用這兩個工具，不然一般人根本沒有機會用到。
所以為了不依賴商業工具，使這份教材可以推廣出去，我們改成使用 <strong>Verilator</strong>，一個完全開源（Open-Source）的 Verilog/SystemVerilog Simulator。</p>
<p>相較於 Icarus Verilog（a.k.a. iverilog），Verilator 最大的特點就是模擬速度很快，非常快（甚至比付費的 Simulator 還快），並且相對於 iverilog，Verilator 對於 SystemVerilog 有良好的支援。
除此之外，在工業上許多工時其實也會使用 Verilator 最爲早期的驗證工具（時間就是金錢！），所以可以知道 Verilator 並不是只是一個 toy project 而已。</p>
<h4 id="how-verilator-works">How Verilator Works<a class="headerlink" href="#how-verilator-works" title="Permanent link">&para;</a></h4>
<blockquote>
<p>The verilator executable is invoked with parameters similar to GCC or other simulators such as Cadence Verilog-XL/NC-Verilog, or Synopsys VCS.
Verilator reads the specified SystemVerilog code, lints it, optionally adds coverage and waveform tracing support, and compiles the design into a source-level multithreaded C++ or SystemC “model”.
The resulting model’s C++ or SystemC code is output as .cpp and .h files. This is referred to as “<mark>Verilating</mark>”, andrthe process is “to <mark>Verilate</mark>”; the output is a “Verilated” model.</p>
</blockquote>
<h3 id="systemverilog-dpi-c-mechanism">SystemVerilog DPI-C Mechanism<a class="headerlink" href="#systemverilog-dpi-c-mechanism" title="Permanent link">&para;</a></h3>
<p>TBD</p>
<h3 id="softwarehardware-co-simulation-differential-testing">Software/Hardware Co-Simulation - Differential Testing<a class="headerlink" href="#softwarehardware-co-simulation-differential-testing" title="Permanent link">&para;</a></h3>
<p>還記得我們在 Lab 2 的時候設計了一個 <strong><em>instruction-driven</em></strong> 的 ISA Simulator (ISS) 嗎？之所以會叫大家在實際使用 HDL 撰寫 RTL-Level CPU 之前先用 C 語言刻出一個 ISS 是有原因的。
基本上，我們已經利用許多測試程式對我們的 ISS 做初步的驗證了，假設你的 ISS 有通過助教提供的所有測資的話，假設助教提供的測資集合為 <span class="arithmatex">\(S\)</span>，我們可以假定，在我們只使用 <span class="arithmatex">\(S\)</span> 來進行測試的前提下，我們所實作的 ISS 可以作為 <strong><em>Reference Model (Golden Model)</em></strong>。</p>
<p>大家應該都多少體驗過看波形地獄吧XD，但有了 ISS 之後，在我們設計 CPU 的時候，就可以做 <strong>Co-Simulation</strong>。
具體來說，Co-Simulation 指的是把我們的 ISS 和 Single-Cycle CPU 做 Co-sim，把 ISS 當作 Golden Model，然後去嘗試捕捉 CPU 的錯誤。
但有一個問題是，ISS 是用 C 語言實作的，而 CPU 則是用 SystemVerilog 實作的，而我們的 Testbench 則是混合了 SystemVerilog 還有 C++ 這兩種語言，這樣不同語言之間要怎麼樣才能做 co-sim 呢？
這就會需要使用到 SystemVerilog 的 DPI-C 機制。DPI-C 機制讓我們可以在 SystemVerilog 和 C 語言之間傳遞資訊，還有讓 SystemVerilog 呼叫 C Function，或是讓 C Program 呼叫 SystemVerilog Function/Task。</p>
<div class="admonition info">
<p class="admonition-title">DiffTest</p>
<p>其實這種 Co-Simulation 的方式並不少見，在業界已經是很常見的方法，而我們所用的這套 Differential Testing 框架其實是參考中國那邊幾個很有名的專案，大家可以參考以下資訊</p>
<ol>
<li><a href="https://ysyx.oscc.cc/">一生一芯計畫</a></li>
<li><a href="https://docs.xiangshan.cc/zh-cn/latest/tools/difftest/">协同仿真框架 (DiffTest)</a></li>
</ol>
</div>
<p>Differential Tstgin 這套框架本身有很多可以發展和優化的空間，但在這裡我們僅僅討論 DiffTest 最核心的概念，以及它該如何幫助我們更有效率地進行 <strong>Design Verification</strong>。
一般在我們直接看波形（Waveform）進行除錯的過程中，我們常常需要做的事情就是<strong>定位第一個錯誤發生的時機</strong>。直接使用波形除錯的好處就是需要的前置處理工作很少，在模擬結束後把波形 dump 出來就可以直接用工具來看波形。
這樣子的方式或許在我們的 Test Program 還很小的時候不會遇到太大的困難，但假如今天大家要跑的模擬程式是一個作業系統，動不動模擬就是上億個 Cycle 起跳的話，這時候只依賴波形就會變成一件不切實際的事情。</p>
<p>DiffTest 的概念是我們需要一個 Golden Model 作為參考答案，並且在<strong>每條指令執行完之後都執行一次比對</strong>，如此一來我們就可以在第一個出錯的瞬間捕捉到錯誤。
但有一個很重要的問題是，<font color="red"><strong>我們應該要比對 Gloden Model 和 DUT 之間的什麼東西？</strong></font>
大家應該還記得我們在 Lab 2 裡面最一開始說的，CPU 本質上就是 Combitional Logic 加上 Sequantial Logic，可以被視為一個巨大的有限狀態機（FSM），對於指令的執行來說，我們可以比對的就是 CPU 的狀態！而 CPU 的狀態則由 PC、Register 和 Memory 所組成。</p>
<p>為了實現 DiffTest，具體來說我們需要幫我們的 Golden Model（也就是 Lab 2 實作的 ISS）加上幾個 API：</p>
<ol>
<li><code>void difftest_init(void)</code></li>
<li><code>viud difftest_get_current_pc(void *buf)</code></li>
<li><code>void difftset_get_regs(void *buf)</code></li>
<li><code>void difftest_set_regs(cosnt void* regs_from_dut)</code></li>
<li><code>void difftest_memcpy_from_dut(uint64_t addr, const void* buf, size_t mem_size)</code></li>
<li><code>void difftest_step(void)</code></li>
<li><code>void difftest_fini(void)</code></li>
</ol>
<p>再來，我們分析 <code>testbench.sv</code> 中關於 DiffTest 的部分（<font color="red">在 <code>testbench.sv</code> 中的 DPI-C function 的定義都在 <code>difftest.cpp</code> 中</font>）</p>
<div class="language-verilog highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Part of testbench.sv</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span>
<span class="normal"><a href="#__codelineno-13-32">32</a></span>
<span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span>
<span class="normal"><a href="#__codelineno-13-41">41</a></span>
<span class="normal"><a href="#__codelineno-13-42">42</a></span>
<span class="normal"><a href="#__codelineno-13-43">43</a></span>
<span class="normal"><a href="#__codelineno-13-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1">// defines</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="cp">`define CYCLE 10</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="cp">`define MAX_CLOCK_CYCLE 1000000</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="cp">`define SO_FILE_NAME &quot;iss/build/libiss.so&quot;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="cp">`define IM core.im.mem</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="cp">`define DM core.dm.mem</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="cp">`define REGFILE core.regfile.mem</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="cp">`define PC core.pc.current_pc</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="c1">// DPI-C function declaration (8 functions in total)</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="kn">import</span> <span class="err">&quot;</span><span class="nn">DPI</span><span class="o">-</span><span class="n">C</span><span class="s">&quot; function void difftest_init(input string so_file_name);</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="kn">import</span> <span class="err">&quot;</span><span class="nn">DPI</span><span class="o">-</span><span class="n">C</span><span class="s">&quot; function void difftest_memcpy_from_dut(input logic [7:0] MEM[65536]);</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="kn">import</span> <span class="err">&quot;</span><span class="nn">DPI</span><span class="o">-</span><span class="n">C</span><span class="s">&quot; function void difftest_get_current_pc(input logic [63:0] current_pc);</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="kn">import</span> <span class="err">&quot;</span><span class="nn">DPI</span><span class="o">-</span><span class="n">C</span><span class="s">&quot; function void difftest_get_regs(input logic [63:0] regFile[32]);</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="kn">import</span> <span class="err">&quot;</span><span class="nn">DPI</span><span class="o">-</span><span class="n">C</span><span class="s">&quot; function void difftest_set_regs();</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="kn">import</span> <span class="err">&quot;</span><span class="nn">DPI</span><span class="o">-</span><span class="n">C</span><span class="s">&quot; function void difftest_check(inout bit success_flag);</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="kn">import</span> <span class="err">&quot;</span><span class="nn">DPI</span><span class="o">-</span><span class="n">C</span><span class="s">&quot; function void difftest_step();</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="kn">import</span> <span class="err">&quot;</span><span class="nn">DPI</span><span class="o">-</span><span class="n">C</span><span class="s">&quot; function void difftest_fini();</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="k">module</span><span class="w"> </span><span class="n">testbench</span><span class="p">;</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="w">    </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="w">        </span><span class="c1">// initialize difftest framework</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">        </span><span class="n">difftest_init</span><span class="p">(</span><span class="no">`SO_FILE_NAME</span><span class="p">);</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="w">        </span><span class="c1">// copy register contents from dut to ref</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="w">        </span><span class="n">difftest_get_regs</span><span class="p">(</span><span class="no">`REGFILE</span><span class="p">);</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="w">        </span><span class="n">difftest_set_regs</span><span class="p">();</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="w">        </span><span class="c1">// copy memory contents from dut to ref</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="w">        </span><span class="n">difftest_memcpy_from_dut</span><span class="p">(</span><span class="no">`DM</span><span class="p">);</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="w">        </span><span class="c1">// difftest main loop</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="k">begin</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34"></a><span class="w">            </span><span class="cm">/* call difftest_step() */</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="w">            </span><span class="n">difftest_get_regs</span><span class="p">(</span><span class="no">`REGFILE</span><span class="p">);</span><span class="w">  </span><span class="c1">// get register file of dut</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="w">            </span><span class="n">difftest_get_current_pc</span><span class="p">(</span><span class="no">`PC</span><span class="p">);</span><span class="w">  </span><span class="c1">// get current PC of dut</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="w">            </span><span class="n">difftest_check</span><span class="p">(</span><span class="n">difftest_success_flag</span><span class="p">);</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="w">            </span><span class="n">difftest_step</span><span class="p">();</span><span class="w">  </span><span class="c1">// make ref step one clock cycle</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a><span class="w">            </span><span class="p">#(</span><span class="no">`CYCLE</span><span class="p">);</span><span class="w">  </span><span class="c1">// dut step one clock cycle</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40"></a><span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">difftest_success_flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">);</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42"></a><span class="w">    </span><span class="k">end</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44"></a><span class="k">endmodule</span>
</span></code></pre></div></td></tr></table></div>
<p>如果我們嘗試將 DiffTest 的運作流程視覺化，可以畫出下面這張圖（使用 <em>mermaid</em> 繪製）</p>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant ISS
    participant Testbench
    participant Single-Cycle CPU
    Single-Cycle CPU-&gt;&gt;Single-Cycle CPU: reset PC and GPR
    Single-Cycle CPU-&gt;&gt;Single-Cycle CPU: $readmemh to set MEM
    rect
    note right of ISS: DiffTest Initialization
    Testbench-&gt;&gt;ISS: Initialize ISS
    Single-Cycle CPU-&gt;&gt;Testbench: Sends GPR
    Testbench-&gt;&gt;ISS: Sets GPR
    Single-Cycle CPU-&gt;&gt;Testbench: Sends MEM
    Testbench-&gt;&gt;ISS: Sets MEM
    end
    rect
        note right of Single-Cycle CPU: DiffTest main-loop
        loop Each step
            ISS-&gt;&gt;ISS: difftest_step()
            ISS-&gt;&gt;Testbench: Sends PC and GPR
            Single-Cycle CPU-&gt;Testbench: Step one clock cycle
            Single-Cycle CPU-&gt;&gt;Testbench: Sends PC and GPR
            Testbench-&gt;&gt;Testbench: Check architectural states
        end
    end</code></pre>
</center></p>
<p>可以看到一開始 CPU 本身會先進行初始化，將自身的 GPR 和 PC 都重置，並且使用 SystemVerilog 中的 <code>$readmemh()</code> 系統函式來將 Data Memopry (DM) 和 Instruction Memory (IM) 初始化。
待 CPU 本身初始化完畢之後，就會進入 DiffTest 的 workdlow。最一開始，除了調用 <code>difftest_init()</code> 將 ISS 初始化之外，DiffTest 也要將 CPU 和 ISS 的 <strong>Architectural States</strong> 進行同步 (PC and GPR)，對應到上方圖中的 DiffTest Initialization。
接下來就會進入 Difftest main-loop，在 main-loop 中 DiffTest 會首先呼叫 <code>ref_difftest_step()</code> 使 ISS 執行一條指令，之後在 <code>testbench.sv</code> 中的 <code>#(CYCLE)</code> 會使 simulation time 往後推進一個週期的時間，因此 CPU 也會執行一條指令。
之後就會得到 ISS 和 CPU 各自的 Architectural States 並且進行比較，檢查兩者狀態是否相同。</p>
<h2 id="chapter-4-start-to-do-the-assignment">Chapter 4. Start to Do The Assignment<a class="headerlink" href="#chapter-4-start-to-do-the-assignment" title="Permanent link">&para;</a></h2>
<h3 id="41-assignment-requirement">4.1 Assignment Requirement<a class="headerlink" href="#41-assignment-requirement" title="Permanent link">&para;</a></h3>
<ol>
<li>請完成 Single-Cycle CPU 的實作</li>
<li>通過所有的 <code>inst-tests</code> 和 <code>test-prog</code><ul>
<li>確保程式執行結果正確</li>
<li>確保執行完畢後通過 Differential Testing</li>
</ul>
</li>
</ol>
<h3 id="42-notes">4.2 Notes<a class="headerlink" href="#42-notes" title="Permanent link">&para;</a></h3>
<ol>
<li>Fork the repository the TA provide<ul>
<li>請先打開連結 <a href="https://gitlab.course.aislab.ee.ncku.edu.tw/113-1/lab-5.git">Lab 5</a></li>
<li>點選右上角的 <strong>Fork</strong>
  <figure markdown="span">
    <img alt="" src="../img/lab-5/fork-1.png" width="850" />
  </figure></li>
<li>進到下一個頁面後，把 <strong>Project URL</strong> 的 <strong>namespace</strong> 改成自己的學號，並且將 <strong>Visibility Level</strong> 改成 <strong>Private</strong>
  <figure markdown="span">
    <img alt="" src="../img/lab-5/fork-2.png" width="850" />
  </figure></li>
<li>按下最下面的 <strong>Fork project</strong> 即可得到一份屬於自己私有的 Sample Code Repo</li>
</ul>
</li>
<li>Clone your private repo<ul>
<li>先確定自己已經打開課程開發環境（Container），並且在環境中的 <code>workspace</code> 底下</li>
<li>下載自己的 Private Repo（記得替換 <u>&lt;Your Student ID&gt;</u>）<blockquote>
<p><code>git clone https://gitlab.course.aislab.ee.ncku.edu.tw/&lt;Your Student ID&gt;/lab-5.git</code></p>
</blockquote>
</li>
<li>進入資料夾<blockquote>
<p><code>cd lab-5</code></p>
</blockquote>
</li>
<li>對 Git Submodule 進行初始化<blockquote>
<p><code>git submodule init &amp;&amp; git submodule update --recursive</code></p>
</blockquote>
</li>
</ul>
</li>
<li>Notes<ul>
<li>因為在<strong>預設</strong>情況之下，只要 Gitlab Repo 中包含 <code>.gitlab-ci.yml</code> 檔案就會觸發 CI/CD Pipeline，如果你在前期尚未完成作業的時候不想觸發 Pipeline，可以先在 Gitlab 你的 Private Repo 中的設定將 CI/CD 功能關閉，待完成作業之後再打開</li>
</ul>
</li>
<li><strong>請記得依據 <a href="https://hedgedoc.course.aislab.ee.ncku.edu.tw/qQA5xz8oTd6e8zmskpIPsQ?view">Assignment 5 Report Template</a> 撰寫本次作業的報告，並且繳交報告連結到成大 Moodle 作業繳交區上</strong></li>
</ol>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; Create by <a href=""  target="_blank" rel="noopener">Jieum.C</a> in 2024 ♥ 

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.instagram.com/eemomolleyball?igsh=MnI5cnM0YnljcnEy" target="_blank" rel="noopener" title="www.instagram.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141m0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7m146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8m76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8M398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.top", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.path", "toc.integrate", "toc.follow", "search.suggest", "search.highlight", "search.relevance", "content.tabs", "content.code.annotation", "content.code.copy", "content.footnotes", "content.images"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../js/custom.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
      
        <script src="../../js/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>