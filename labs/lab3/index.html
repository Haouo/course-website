
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lab2/">
      
      
        <link rel="next" href="../lab4/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.4">
    
    
      
        <title>Lab 3 - Bare-metal Runtime Environment and RISC-V Assembly Programming - Computer Organization Fall 2024 @NCKUEE</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Lab 3 - Bare-metal Runtime Environment and RISC-V Assembly Programming - Computer Organization Fall 2024 @NCKUEE" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="./assets/images/social/labs/lab3.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="None" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Lab 3 - Bare-metal Runtime Environment and RISC-V Assembly Programming - Computer Organization Fall 2024 @NCKUEE" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="./assets/images/social/labs/lab3.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapter-1-application-binary-interface-abi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Computer Organization Fall 2024 @NCKUEE" class="md-header__button md-logo" aria-label="Computer Organization Fall 2024 @NCKUEE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Computer Organization Fall 2024 @NCKUEE
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 3 - Bare-metal Runtime Environment and RISC-V Assembly Programming
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  首頁

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lab_overview/" class="md-tabs__link">
          
  
  Lab material

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../rtl/verilog/" class="md-tabs__link">
          
  
  RTL Programming

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tools/linux_cmd/" class="md-tabs__link">
          
  
  Tools Guide

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../references/" class="md-tabs__link">
        
  
    
  
  補充資料

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Computer Organization Fall 2024 @NCKUEE" class="md-nav__button md-logo" aria-label="Computer Organization Fall 2024 @NCKUEE" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Computer Organization Fall 2024 @NCKUEE
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    首頁
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            首頁
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Lab material
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Lab material
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 0 - How To Ask Questions The Smart Way
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 1 - C Programmin and Compilation Flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 2 - Simple RISC-V ISA Simulator with RV64I
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lab 3 - Bare-metal Runtime Environment and RISC-V Assembly Programming
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lab 3 - Bare-metal Runtime Environment and RISC-V Assembly Programming
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chapter-1-application-binary-interface-abi" class="md-nav__link">
    <span class="md-ellipsis">
      Chapter 1. Application Binary Interface (ABI)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 1. Application Binary Interface (ABI)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-what-is-abi" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 What is ABI?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-risc-v-calling-convention" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 RISC-V Calling Convention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 RISC-V Calling Convention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-integer-register-convention" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 Integer Register Convention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-procedure-calling-convention" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 Procedure Calling Convention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-case-study-calculation-of-fibonacci-number" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.3 Case Study - Calculation of Fibonacci Number
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case-study-c-assembly-hybrid-programming" class="md-nav__link">
    <span class="md-ellipsis">
      Case Study - C-Assembly Hybrid Programming
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chapter-2-bare-metal-runtime-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Chapter 2. Bare-metal Runtime Environment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 2. Bare-metal Runtime Environment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-hardware-dependent-core-library" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Hardware-Dependent Core Library
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-hareware-independent-library" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Hareware-Independent Library
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2 Hareware-Independent Library">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221-io-library" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1 I/O Library
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222-integer-multiplication-and-division-emulation" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2 Integer Multiplication and Division Emulation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#223-floating-point-emulation-library" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3 Floating-Point Emulation Library
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2.3 Floating-Point Emulation Library">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2231-why-floating-instead-of-fixed" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.1 Why Floating instead of Fixed?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2232-ieee-754-single-precision-floating-point-binary32-format" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.2 IEEE 754 Single-Precision Floating-Point (Binary32) Format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2233-rouding-and-calculation-error" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.3 Rouding and Calculation Error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2234-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.3.4 Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chapter-3-how-to-compile-and-run-the-demo" class="md-nav__link">
    <span class="md-ellipsis">
      Chapter 3. How to Compile and Run The Demo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chapter-4-start-to-do-the-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      Chapter 4. Start to Do The Assignment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Chapter 4. Start to Do The Assignment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-assignment-requirement" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Assignment Requirement
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-notes" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 4 - RTL Programming Review using SystemVerilog
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 5 - Single-Cycle CPU Design and Differential Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 6 - Bus Protocol and Arbitration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 7 - Pipeline CPU and Simple Cache Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 8 - Deep Dive into Memory System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 9 - SIMD Accelerator and GEMM Kernel Design
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    RTL Programming
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            RTL Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rtl/verilog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to Verilog and RTL Programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rtl/sv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    From Verilog to SystemVerilog for Hardware Designing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rtl/sva/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SystemVerilog Assertion (SVA)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rtl/chisel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chisel HDL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tools Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tools Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/linux_cmd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic Linux Command
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/git_cmd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/markdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Markdown Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/gitlab_ov/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gitla & Mattermost
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/cli_tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Useful CLI Tools
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    補充資料
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Lab 3 - Bare-metal Runtime Environment and RISC-V Assembly Programming</h1>

<h2 id="chapter-1-application-binary-interface-abi">Chapter 1. Application Binary Interface (ABI)<a class="headerlink" href="#chapter-1-application-binary-interface-abi" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">參考</p>
<p>RISC-V ABI Specification: <a href="https://github.com/riscv-non-isa/riscv-elf-psabi-doc">A RISC-V ELF psABI Document</a></p>
</div>
<h3 id="11-what-is-abi">1.1 What is ABI?<a class="headerlink" href="#11-what-is-abi" title="Permanent link">&para;</a></h3>
<p>ABI 全稱 Application Binary Interface，常常被拿來和 ABI 對比的是 API (Application Programming Interface)。
就定義上來說，ABI 基本上最重要的部分就是規範了 Calling Convention，也就是函數呼叫的過程中，一系列需要遵守的規定，包含暫存器的使用、參數如何傳遞，還有 Caller-Callee Save 等等的議題。
不過，確實你看完這些之後可以知道 ABI 是什麼東西還有 ABI 規範了哪些東西，但是<strong>你知道為什麼需要 ABI 的存在嗎？</strong></p>
<p>通常會關心 ABI 的人是開發編譯工具鏈（如 GCC、LLVM）、開發作業系統還有系統函式庫的開發者，但如果你會在 Assembly-Level 進行開發或者是想要實現跨語言間的函式調用的話，也會需要理解 ABI。</p>
<p>讓我們以參數傳遞為例來解釋 ABI 的重要性。從 CPU 的角度來看，函式的參數可以透過暫存器或堆疊來傳遞。假設我們手寫了一個組合語言程式，並希望在其中呼叫 C 標準函式庫中的 <code>printf</code> 函數，我們該如何正確地傳遞參數呢？
如果沒有 ABI 規範 <strong>函式呼叫約定</strong>（Procedure Calling Convention），你是否能確定該使用哪些暫存器，或是該如何利用堆疊來傳遞參數？</p>
<p>若我們自己假設的參數傳遞方式與編譯器實際遵循的 Calling Convention 不一致，那麼當組合語言程式呼叫 <code>printf</code> 時，參數就無法正確傳遞，導致執行錯誤。
因此，ABI 的存在就是為了提供一套標準，使得不同語言或編譯器之間可以正確地進行互動與協作，確保程式能夠正常運作。</p>
<p>另外一個例子就是我們剛剛提到，當你需要在不同的程式語言之間互相調用函式時，ABI 扮演了至關重要的角色。
例如，你可能需要在 C++ 程式中調用用 Fortran 或 Rust 寫的函式。如果沒有 ABI 的規範，不同語言之間就無法正確地傳遞資料或執行函式。
ABI 確保了每個語言的編譯器<strong>在生成機器碼時</strong>，能夠以相同的方式處理函式調用、參數傳遞和返回值，從而實現跨語言的互操作性。
所以，ABI 的規範主要作用在 Machine-Code-Level，或者說是在程式已經被編譯為 binary 後的層級。它定義了應用程式與作業系統或其他程式之間的互動方式，包括如何傳遞參數、使用暫存器、堆疊管理，以及函式返回值的處理等。因此，ABI 不僅規範了組合語言程式的運作，也同樣影響到編譯後的機器碼，使不同來源的程式碼能夠在執行時正確地協作。</p>
<h3 id="12-risc-v-calling-convention">1.2 RISC-V Calling Convention<a class="headerlink" href="#12-risc-v-calling-convention" title="Permanent link">&para;</a></h3>
<p>作為指令集架構，RISC-V 也有規範自己的 ABI，我們在接下來介紹其中最重要的兩個部分，分別是 <strong>Register Convention</strong> 和 <strong>Procedure Calling Convention</strong>。
不過，RISC-V ABI 並<strong>不限於</strong>我們提到的這兩個部分，大家如果對於完整的 RISC-V ABI 規範有興趣的話，歡迎閱讀官方文件。</p>
<h4 id="121-integer-register-convention">1.2.1 Integer Register Convention<a class="headerlink" href="#121-integer-register-convention" title="Permanent link">&para;</a></h4>
<p><img alt="" src="https://hedgedoc.course.aislab.ee.ncku.edu.tw/uploads/1d911992-9430-46a8-a3b4-a822a9114150.png" /></p>
<p>基本上這個部分有兩大重點，第一個是 <strong>ABI Mnemonic</strong>，再來就是大家上課會學到的 <strong>Caller/Callee-Saved</strong> 的概念。
ABI Mnemonic 的命名規定其實也是為了配合 Calling Convention，並且讓 Programmer 在使用 RISC-V 組合語言撰寫程式的時候更加方便
。如果單純看這些暫存器的別名，其實意義並不大。</p>
<p>要特別注意的是，上面的圖片當中有一欄是 <em>Preserved across calls</em>，這對應到 Callee-saved，以 <code>$ra</code> 為例，它的 Preserved across calls 屬性被標記為 No，表示 Caller 不可以預設 <code>$ra</code> 在進行 Procedure Calling 之後，其值會保持不變。
也因此當 <code>$ra</code> 的值對 Caller 來說是重要的話（也就表示會被用到），那麼 Caller 有自己保存 <code>$ra</code> 的<strong>責任</strong>。換句話說，<code>$ra</code> 這個暫存器是 Caller-saved。</p>
<h4 id="122-procedure-calling-convention">1.2.2 Procedure Calling Convention<a class="headerlink" href="#122-procedure-calling-convention" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title">Caller/Callee-saved 的概念到底是什麼？</p>
<p>Caller-saved 表示 Caller 本身必須負起保留特定暫存器的責任。
以 t0 暫存器為例，如果今天 caller 自己有使用到 t0，那麼他在進行 procedure calling 之前，
因為 t0 是 caller-saved，也就表示 callee 是可以隨意使用 t0 並且不用負起任何<strong>責任</strong>（也就表示即使改變 t0 也不用復原它），
但是對於 caller 來說 t0 如果在進行 procedure calling 然後 return 之後值就被改變了的話，可能會造成運算錯誤，
所以 caller 就必須在 procedure calling 之前先利用 stack 的空間保存 t0 的值，這樣即使經過 procedure calling 之後 t0 被改變了，
caller 依然可以利用 stack 中所保存的資訊來恢復 t0 並繼續進行運算。</p>
<p>而 callee-saved 的概念就類比於 caller-saved，對於 callee-saved 的暫存器來說，我們以 s0 為例，s 是 saved 的簡寫，這裡所說的 saved register 是以 caller 的角度出發。
也就是對於 caller 來說，它可以認定 s0 ~ s11 這十二個暫存器是為了 caller 而保留的，因此 caller 可以假設即使經過 procedure calling，在 procedure return 之後 s0 ~ s11 的值是不會改變的。
但是，如果為了達到這樣子的需求我們直接限制 callee 不可以使用 s0 ~ s11 的話，相當於有一大部分的暫存器都不能使用了，這樣對效能一定會有相當大的衝擊。
因此，實際上 callee 依然可以使用 saved register，但是這時候 callee 就有了<strong>使用後必須還原的責任</strong>，這樣就可以營造一個對於 caller 來說看起來 saved register 不會被改變的錯覺（illusion）。
對於 callee 來說，一樣是利用 stack 來保存 callee-saved register，在進入 procedure 的最一開始先保存這些暫存器之後再開始進行運算，結束運算之後將這些暫存器復原並且恢復 stack 之後，才 return 回到 caller。
這樣對於 caller 來說<strong>看起來</strong> saved register 似乎沒有被動過，但實際上是可能被使用過，但是又被還原了。</p>
</div>
<p>總結來說，RISC-V ABI 當中對於 Function Call 有著下面這些規範（只講述最為重要的部分）</p>
<ol>
<li>the contents of any register without specifying it as an argument register in the calling convention are unspecified upon entry</li>
<li>the content of any register without specifying it as a return value register or callee-saved in the calling convention are unspecified upon exit</li>
<li>the contents of all callee-saved registers must be restored to what was set on entry</li>
<li>the contents of any fixed registers like gp and tp never change</li>
<li>The base integer calling convention provides eight argument registers, a0-a7, the first two of which are also used to return values</li>
<li>Scalars that are at most XLEN bits wide are passed in a single argument register, or on the stack by value if none is available.</li>
<li>
<p><strong>About the stack itself</strong></p>
<ul>
<li>The stack grows downwards (towards lower addresses)</li>
<li>the stack pointer shall be aligned to a 128-bit boundary upon procedure entry</li>
<li>
<p>The first argument passed on the stack is located at offset zero of the stack pointer on function entry; following arguments are stored at correspondingly higher addresses</p>
<blockquote>
<p>這條規範<strong>針對</strong>的是多出來必須用 Stack 傳遞的 Function Argument，要從 offset 等於 0 開始，但是如果是在 Function Prologue &amp; Epilogue 保存暫存器（e.g., Callee-Saved）的話，並不用遵守這個限制</p>
</blockquote>
</li>
<li>
<p>In the standard ABI, the stack pointer must remain aligned throughout procedure execution</p>
</li>
</ul>
</li>
</ol>
<p>在 Assembly Programming 中，Procedure（或稱 Function）通常（但不一定）會包含三個部分，分別是 <strong>Prologue</strong>、<strong>Procedure Body</strong> 還有 <strong>Epilogue</strong>。如果直接撰寫 C 語言中的 Function，通常不會注意到 Prologue 還有 Epilogue，因為在編譯階段，編譯器就會自動替我們的 C Function 加上 Prologue 和 Epilogue 來進行 Stack 和 Register 的管理，讓我們可以專注在 Procedure Body 的實作即可。但是當我們使用組合語言撰寫程式的時候，我們就必須自己實作出 Prologue 和 Epilogue，這樣才得以遵守 Procedure Calling Convention，把該存的資料存進 Stack 當中，並且在必要的時候將資料還原。</p>
<div class="admonition info">
<p class="admonition-title">參考</p>
<p>在程式設計中，function prologue 和 epilogue 是函數進入與退出的過程。這些步驟主要與堆疊的使用和寄存器的保存有關，是編譯器在生成組合語言或機器碼時自動添加的，以便確保函數能正確地呼叫與返回，且不影響主程式的其他部分。</p>
<p>參考：<a href="https://en.wikipedia.org/wiki/Function_prologue_and_epilogue">Wikipedia - Function prologue and epilogue</a></p>
</div>
<h4 id="123-case-study-calculation-of-fibonacci-number">1.2.3 Case Study - Calculation of Fibonacci Number<a class="headerlink" href="#123-case-study-calculation-of-fibonacci-number" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title">參考編譯指令</p>
<ul>
<li><code>riscv64-unknown-elf-gcc -march=rv64i -mabi=lp64 -S -O0 -fomit-fram-pointer &lt;file-name&gt;</code><ul>
<li>你可以試試看把 <code>-fomit-frame-pointer</code> 從指令中移除並且再次編譯，觀察產生出的 assembly code 發生了什麼變化？（關鍵字：RISC-V Frame-Pointer）</li>
<li><strong>Frame-Pointer is not necessary but useful for debugging</strong></li>
</ul>
</li>
</ul>
</div>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>費波那契數列常常被作為 Assembly Programing 的經典題目，甚至考研究所的題目也曾經出現過。
但是，這個程式卻也常常讓人看不出來關於 Caller-saved 和 Callee-saved 的界線，也就是說看不出來到底誰是 Caller 而誰是 Callee。</p>
<div class="language-asm highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="w">    </span><span class="na">.file</span><span class="w">   </span><span class="s">&quot;fib.c&quot;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="na">.text</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="na">.align</span><span class="w">  </span><span class="mi">2</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="na">.globl</span><span class="w">  </span><span class="no">fib</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="na">.type</span><span class="w">   </span><span class="no">fib</span><span class="p">,</span><span class="w"> </span><span class="na">@function</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="nl">fib:</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="c1"># prologue</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="nf">addi</span><span class="w">    </span><span class="no">sp</span><span class="p">,</span><span class="no">sp</span><span class="p">,-</span><span class="mi">32</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="nf">sd</span><span class="w">  </span><span class="no">ra</span><span class="p">,</span><span class="mi">24</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nf">sd</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="mi">16</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="nf">sd</span><span class="w">  </span><span class="no">a0</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="c1"># function body</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nf">ld</span><span class="w">  </span><span class="no">a4</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">1</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nf">bgtu</span><span class="w">    </span><span class="no">a4</span><span class="p">,</span><span class="no">a5</span><span class="p">,.</span><span class="no">L2</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="nf">ld</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nf">j</span><span class="w">   </span><span class="no">.L3</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="nl">.L2:</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="nf">ld</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="nf">addi</span><span class="w">    </span><span class="no">a5</span><span class="p">,</span><span class="no">a5</span><span class="p">,-</span><span class="mi">1</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="nf">mv</span><span class="w">  </span><span class="no">a0</span><span class="p">,</span><span class="no">a5</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">fib</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="nf">mv</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="no">a0</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="nf">ld</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="nf">addi</span><span class="w">    </span><span class="no">a5</span><span class="p">,</span><span class="no">a5</span><span class="p">,-</span><span class="mi">2</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">    </span><span class="nf">mv</span><span class="w">  </span><span class="no">a0</span><span class="p">,</span><span class="no">a5</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">fib</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">    </span><span class="nf">mv</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="no">a0</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">a5</span><span class="p">,</span><span class="no">s0</span><span class="p">,</span><span class="no">a5</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="nl">.L3:</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">    </span><span class="c1"># epilogue</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">    </span><span class="nf">mv</span><span class="w">  </span><span class="no">a0</span><span class="p">,</span><span class="no">a5</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">    </span><span class="nf">ld</span><span class="w">  </span><span class="no">ra</span><span class="p">,</span><span class="mi">24</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">    </span><span class="nf">ld</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="mi">16</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">    </span><span class="nf">addi</span><span class="w">    </span><span class="no">sp</span><span class="p">,</span><span class="no">sp</span><span class="p">,</span><span class="mi">32</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">    </span><span class="nf">jr</span><span class="w">  </span><span class="no">ra</span>
</span></code></pre></div></td></tr></table></div>
<p>會造成混淆最根本的原因是因為 <code>fib</code> 這個 function 本身是一個 Recursive Function，換句話說 fib 同時是 Caller 也是 Callee，因為他會呼叫自身（call itself），所以也會造成 Caller-saved 和 Callee-saved 這兩個部分可以被放在一起。
我們觀察上面的組合語言可以看到在 Function Prologue 的部分，保存了暫存器 ra、s0 和 a0，我們查閱前面提到的 Integer Register Convention 可以發現只有 s0 是 Callee-saved，但是 ra 和 a0 其實都是 Caller-saved。
不過在 GCC 所產生的組合語言當中，我們可以看到這兩個部分都被放到了 Prologue 當中。</p>
<h4 id="case-study-c-assembly-hybrid-programming">Case Study - C-Assembly Hybrid Programming<a class="headerlink" href="#case-study-c-assembly-hybrid-programming" title="Permanent link">&para;</a></h4>
<p>在系統軟體的開發中，尤其像是作業系統或是驅動程式（Driver），常常需要直接使用組合語言實作部分的 Function，並且在 C 語言中呼叫這些用組合語言實作的 Function。
我們稱這種開發情境叫做 <strong><em>C-Assembly Hybrid Programming</em></strong>，在這種情境底下遵守 ABI 就顯得特別重要，尤其是對於撰寫組合語言的開發者來說。</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>假設我們使用 RISC-V Assembly 來完成 <code>int sum(int, int, int)</code> 的實作，並且在 C Source Code 中呼叫 <code>sum()</code>，我們先把 <code>foo()</code> 這個函式編譯成只使用 RV64I 指令的組合語言</p>
<div class="language-asm highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="w">    </span><span class="na">.file</span><span class="w">   </span><span class="s">&quot;foo.c&quot;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="na">.text</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="na">.align</span><span class="w">  </span><span class="mi">2</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="na">.globl</span><span class="w">  </span><span class="no">foo</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="na">.type</span><span class="w">   </span><span class="no">foo</span><span class="p">,</span><span class="w"> </span><span class="na">@function</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="nl">foo:</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="c1"># function prologue</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="nf">addi</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="no">sp</span><span class="p">,-</span><span class="mi">16</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">ra</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="c1"># function body</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">a2</span><span class="p">,</span><span class="mi">3</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">a1</span><span class="p">,</span><span class="mi">2</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="nf">li</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="mi">1</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">sum</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">    </span><span class="nf">mv</span><span class="w"> </span><span class="no">a5</span><span class="p">,</span><span class="no">a0</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="nf">mv</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="no">a5</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="c1"># function epilogue</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">ra</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="nf">addi</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="no">sp</span><span class="p">,</span><span class="mi">16</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="nf">jr</span><span class="w"> </span><span class="no">ra</span><span class="w"> </span><span class="c1"># alias for: jalr x0, ra, 0</span>
</span></code></pre></div></td></tr></table></div>
<p>我們可以看到 GCC C Compiler 將這段 C 語言程式碼轉換成 RV64I 組合語言的時候，使用了 a0、a1 和 a2 來傳遞參數給 sum 函式。
進入 sum 函式之後，先在 stack 上分配了 16-bytes 的空間，並且使用其中一個 double-word 大小的空間來保存 ra，並且將參數利用 load-immediate (<code>li</code>) 指令載入暫存器之後，利用 <code>call</code> 這個 pseudo-instruction 來呼叫函式 <code>sum</code>，
之後再將 a0 的值複製到 a5，並且再將 a5 的值複製回 a0，之後便恢復原本 ra 的值，然後就 return（對應到 <code>jr ra</code>），由此也可以看出這裡一樣遵守 RISC-V ABI 的規範，將 return value 存放在 a0 當中。</p>
<p>如果今天沒有一套明確的規範，尤其是針對 Calling Convention，那麼對於使用 assembly code 實作 sum 函式的這個人來說就會非常苦惱，因為他會不知道到底參數透過哪些暫存器傳遞、不知道他該負起哪些責任保證哪些暫存器的值會在函式調用的前後保持一致，還有傳回 return value 的時候又該放在哪個暫存器。
以下我們遵守 ABI 的規範，示範一個 sum 函式的組合語言實作。</p>
<div class="language-asm highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="w">    </span><span class="na">.file</span><span class="w">    </span><span class="no">sum.s</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="na">.text</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="na">.align</span><span class="w">   </span><span class="mi">2</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="na">.global</span><span class="w">  </span><span class="no">sum</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="na">.type</span><span class="w">    </span><span class="no">sum</span><span class="p">,</span><span class="w"> </span><span class="na">@function</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="nl">sum:</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="c1"># function prologue</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nf">addi</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="nf">sd</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="c1"># function body</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="nf">mv</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="no">a0</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="no">a1</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="no">a2</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="nf">mv</span><span class="w"> </span><span class="no">a0</span><span class="p">,</span><span class="w"> </span><span class="no">s0</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="c1"># function epilogue</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="nf">ld</span><span class="w"> </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="nf">addi</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="nf">ret</span>
</span></code></pre></div></td></tr></table></div>
<p>如此一來，即使我們是使用 assembly 實作 sum 函式，但是因為我們嚴格依照 RISC-V ABI 規範去實作，就可以和以 C 語言撰寫的 foo 函式互相配合，而不會出現錯誤。</p>
<p>再讓我們看一個更極端的例子，假設我們有八個以上的參數要進行傳遞的話，依照前面的論述，如果 a0 ~ a7 這八個暫存器不敷使用的話，會使用 Stack 來傳遞剩餘參數。考慮以下 C Code：</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>使用 <code>riscv64-unknown-elf-gcc -march=rv64i -mabi=lp64 -O0 -fomit-frame-pointer -S foo.c</code>，我們可以得到以下的結果</p>
<div class="language-asm highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="w">    </span><span class="na">.option</span><span class="w"> </span><span class="no">nopic</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="na">.text</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="na">.align</span><span class="w">  </span><span class="mi">2</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="na">.globl</span><span class="w">  </span><span class="no">foo</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="na">.type</span><span class="w">   </span><span class="no">foo</span><span class="p">,</span><span class="w"> </span><span class="na">@function</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="nl">foo:</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">    </span><span class="c1"># allocate 32-bytes in the stack to pass last two arguments</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="nf">addi</span><span class="w">    </span><span class="no">sp</span><span class="p">,</span><span class="no">sp</span><span class="p">,-</span><span class="mi">32</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">    </span><span class="nf">sd</span><span class="w">  </span><span class="no">ra</span><span class="p">,</span><span class="mi">24</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">10</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="nf">sd</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">8</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">9</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="nf">sd</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">0</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">    </span><span class="c1"># pass the first 8 arguments by using a0 ~ a7</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a7</span><span class="p">,</span><span class="mi">8</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a6</span><span class="p">,</span><span class="mi">7</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="mi">6</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a4</span><span class="p">,</span><span class="mi">5</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a3</span><span class="p">,</span><span class="mi">4</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a2</span><span class="p">,</span><span class="mi">3</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a1</span><span class="p">,</span><span class="mi">2</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">    </span><span class="nf">li</span><span class="w">  </span><span class="no">a0</span><span class="p">,</span><span class="mi">1</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">sum</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="nf">mv</span><span class="w">  </span><span class="no">a5</span><span class="p">,</span><span class="no">a0</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">    </span><span class="nf">mv</span><span class="w">  </span><span class="no">a0</span><span class="p">,</span><span class="no">a5</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">    </span><span class="nf">ld</span><span class="w">  </span><span class="no">ra</span><span class="p">,</span><span class="mi">24</span><span class="p">(</span><span class="no">sp</span><span class="p">)</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="nf">addi</span><span class="w">    </span><span class="no">sp</span><span class="p">,</span><span class="no">sp</span><span class="p">,</span><span class="mi">32</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">    </span><span class="nf">jr</span><span class="w">  </span><span class="no">ra</span>
</span></code></pre></div></td></tr></table></div>
<p>根據前面我們提到 RISC-V ABI 的規則，在當使用 Stack 進行參數傳遞的時候，第一個要放進 Stack 中的參數應該放在 offset 等於 0 的位置，而根據上面的 Assembly Code，它確實把第九個參數，常數 9 放在 stack 中 offset 為 0 的位置，對應到 <code>li a5, 9</code> 和 <code>sd a5, 0(sp)</code>，符合 RISC-V ABI 的規範。</p>
<div class="admonition note">
<p class="admonition-title">More about ABI - Named ABI and C/C++ Type Details</p>
<p><strong>編譯的時候，傳入的 options 中的其中一個 <code>-mabi=lp64</code> 功能到底是什麼？</strong></p>
<p>ABI 除了規範我們前面提到的 Register Convention 和 Procedure Calling Convention 以外，也規範了 C/C++ Type Details。
在 Type Details 當中，規範了 C/C++ 中各種不同 Data Types 的 <strong>size</strong> 和 <strong>alignment</strong>。</p>
<p>LP64, LP64F, LP64D, and LP64Q: Use the following type sizes and alignments (based on the LP64 convention):</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Type</th>
<th style="text-align: center;">Size (Bytes)</th>
<th style="text-align: center;">Alignment (Bytes)</th>
<th style="text-align: left;">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">bool/_Bool</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">char</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">short</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">int</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">4</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">long</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">8</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">long long</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">8</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">__int128</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">16</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">void *</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">8</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">__bf16</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: left;">Half precision floating point (bfloat16)</td>
</tr>
<tr>
<td style="text-align: left;">_Float16</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: left;">Half precision floating point (binary16 in IEEE 754-2008)</td>
</tr>
<tr>
<td style="text-align: left;">float</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">4</td>
<td style="text-align: left;">Single precision floating point (binary32 in IEEE 754-2008)</td>
</tr>
<tr>
<td style="text-align: left;">double</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">8</td>
<td style="text-align: left;">Double precision floating point (binary64 in IEEE 754-2008)</td>
</tr>
<tr>
<td style="text-align: left;">long double</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">16</td>
<td style="text-align: left;">Quadruple precision floating point (binary128 in IEEE 754-2008)</td>
</tr>
<tr>
<td style="text-align: left;">float _Complex</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">4</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">double _Complex</td>
<td style="text-align: center;">16</td>
<td style="text-align: center;">8</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;">long double _Complex</td>
<td style="text-align: center;">32</td>
<td style="text-align: center;">16</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>以 RV64 來說，總共定義了 LP64、LD64F、LP64D 和 LP64Q 這四種 Named ABI，他們的 Type Details 都基於上面的表格，唯一不同的是 F、D 和 Q 代表是否使用 RISC-V 的浮點數擴展（Extension）。
以 LP64 為例，L 代表 Long 且 P 代表 Pointer，所以 LP64 代表 Long 和 Pointer 的長度都是 64-bit。
我們以 <code>unsigned int</code> 和 <code>unsigned long</code> 為例，在 LP64 的規範中，前者的長度是 32-bit 而後者是 64-bit，這樣的差異會直接影響到兩者可以表示的值域範圍。
只不過就算我們在寫程式的時候使用的是 32-bit 長度甚至是更小的 data type，還是依然會被載入到 64-bit 的暫存器中再進行運算。 </p>
</div>
<h2 id="chapter-2-bare-metal-runtime-environment">Chapter 2. Bare-metal Runtime Environment<a class="headerlink" href="#chapter-2-bare-metal-runtime-environment" title="Permanent link">&para;</a></h2>
<p>以目前我們實作的 Simple RISC-V ISA Simulator 來說，已經具備最基本的整數運算功能，還有輸出輸入的功能，那是否代表我們已經可以用這個 Simulator 來執行各種程式了？
這個問題攸關於<strong>圖靈完備性</strong>（Turing Complete）。簡單來說，目前我們所實作的 ISS 已經具備基本的算術指令、分支指令（Branch &amp; Dump）還有 Load/Store 指令，
所以已經可以模擬一個圖靈機（Turing Machine）的運作，可以解決通用計算問題。
再加上我們利用 ECALL 指令的實作賦予我們的系統 I/O 的功能，讓我們可以更輕易地觀察系統的運作並且和系統進行互動。</p>
<p>但是，即使我們的 ISS 已經具備計算任何可計算問題的能力了，但有一個令人頭疼的問題是，<mark>在這樣的系統上面進行開發容易嗎？</mark>
不論是開發 CPU，或是開發各式各樣不同形式的計算機系統，我們終究需要在其上開發軟體，使其可以依照我們想要的方式進行運作，因此關注開發容易程度是一件重要的事情。</p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>這個問題可以進一部探討到作業系統的誕生，還有各式各樣系統軟體的發展。</p>
</div>
<p>回憶一下助教在 Lab 2 提供的範例程式 <code>hello.c</code>，它可以使 ISS 輸出 <code>Hello, World!</code> 並結束，這個程式的原始碼如下：</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span>
<span class="normal"><a href="#__codelineno-7-47">47</a></span>
<span class="normal"><a href="#__codelineno-7-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="cm">/* print the string &quot;Hello, World!\n&quot; and ends the program */</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;H&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;H&#39;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;e&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;e&#39;</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;l&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;l&#39;</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;l&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;l&#39;</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;o&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;o&#39;</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;,&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;,&#39;</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39; &#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39; &#39;</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;W&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;W&#39;</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;o&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;o&#39;</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;r&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;r&#39;</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;l&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;l&#39;</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;d&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;d&#39;</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;!&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;!&#39;</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42"></a><span class="w">                 </span><span class="s">&quot;li a0, 1</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="w">                 </span><span class="s">&quot;li a1, &#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// &#39;\n&#39;</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45"></a><span class="w">                 </span><span class="s">&quot;li a0, 0</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="w">                 </span><span class="s">&quot;ecall</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// end the program</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>在大家的記憶中本應該只需要 <code>#include &lt;stdio.h&gt;</code> 和 <code>printf("Hello, World!\n")</code> 就好了，為什麼現在需要寫這麼多程式碼，甚至需要手寫組合語言才能達到一樣的功能？
我們換個方式思考，其實所有在 CPU 上面運作的程式都會先被 Compiler 編譯成對應特定指令集架構的組合語言，然後再經由 Assembler 轉換成機械碼之後，最後才得以運行在 CPU 之上，因為特定的指令才是 CPU 得以解讀的資訊。
所以，使用組合語言撰寫任何程式其實是一件符合直覺得事情。但是我們之所以很少這樣做的原因就是因為，這樣做效率太低了！
在你之前寫程式的記憶當中，你隨意呼叫的一個 C Standard Library 中的 Function 背後可能都對應到上萬條組合語言，你有辦法想像這幾萬條指令都靠你手動自己一個一個寫出來嗎，顯然這是不切實際的。</p>
<h3 id="21-hardware-dependent-core-library">2.1 Hardware-Dependent Core Library<a class="headerlink" href="#21-hardware-dependent-core-library" title="Permanent link">&para;</a></h3>
<p>目前對我們的 ISA Simulator 來說，直接和硬體相關的並且我們需要的操作有兩個</p>
<ol>
<li>控制 ISS 是否停止執行指令（Halt）<ul>
<li>因為 ISS 本身會不斷地重複執行指令的這個步驟，因此必須要提供一個機制，來告訴 ISS 什麼時候應該要停下來，並且將控制權轉移回 User 手上</li>
</ul>
</li>
<li>I/O 相關功能（輸出、輸入）<ul>
<li>目前僅實作輸出的功能，暫時不實作輸入功能</li>
<li>輸出相關的函數如 <code>putchar</code>、<code>putint</code> 和 <code>printf</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>Use abstraction to simplify design.<br>
----- 8 Great Ideas in Computer Architecture, By David A. Patterson, PhD</p>
</blockquote>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">core.h</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="cp">#ifndef __CORE_H__</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="cp">#define __CORE_H__</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="cm">/* system call enumeration list */</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="cp">#define SYS_EXIT 0</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="cp">#define SYS_PUTC 1</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__internal_syscall</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">arg0</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">arg1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="k">register</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;a0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg0</span><span class="p">;</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">    </span><span class="k">register</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="k">asm</span><span class="p">(</span><span class="s">&quot;a1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg1</span><span class="p">;</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;ecall&quot;</span><span class="w"> </span><span class="o">::</span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="p">);</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="p">}</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="cp">#define SYSCALL_1(A0) __internal_syscall(A0, 0)</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="cp">#define SYSCALL_2(A0, A1) __internal_syscall(A0, A1)</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="cm">/* function used to exit the current running program */</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noreturn</span><span class="p">));</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21"></a>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="cm">/* basic output function (single character as unit) */</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">platform_outb</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24"></a>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="cp">#endif</span>
</span></code></pre></div></td></tr></table></div>
<p>在 <code>core.h</code> 中我們首先定義了 <code>__internal_syscall</code> 這個函式，作為硬體相關函式呼叫的基礎，然後基於參數個數的不同，我們又分別定義了 <code>SYSCALL_1</code> 和 <code>SYSCALL_2</code>。
接下來我們宣告（Declare）了最重要的兩個函式，分別是 <code>terminate</code> 用來作為 RISC-V Program 結束時應該要主動呼叫的函式，以讓 ISS 停下。
而 <code>platform_outb</code> 則可以向 ISS 發出請求，請其幫忙印出一個字元（character）。</p>
<blockquote>
<p>因為 <code>char</code> 的大小為一個 byte，因此該函數的後綴 outb 代表的含義是 output byte。</p>
</blockquote>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">core.c</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span>
<span class="normal"><a href="#__codelineno-9-7">7</a></span>
<span class="normal"><a href="#__codelineno-9-8">8</a></span>
<span class="normal"><a href="#__codelineno-9-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core.h&quot;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">        </span><span class="n">SYSCALL_1</span><span class="p">(</span><span class="n">SYS_EXIT</span><span class="p">);</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="p">}</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="kt">void</span><span class="w"> </span><span class="nf">platform_outb</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">SYSCALL_2</span><span class="p">(</span><span class="n">SYS_PUTC</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>在 <code>core.c</code> 中我們定義（Define）了 <code>terminate</code> 和 <code>platform_outb</code>。因為 <code>terminate</code> 只需要傳入一個參數，也就是暫存器 $a0 的值，更精確地說是將 $a0 設為 0，所以實作上我們使用 <code>SYSCALL_1</code>。
而根據 Lab 2 對 ISS 的實作規範，我們可以得知 <code>platform_outb</code> 要在呼叫 ECALL 指令之前將 $a0 設成 1，並且將欲印出的字元的數值放進 $a1 當中，因此我們使用 <code>SYSCALL_2</code>。</p>
<h3 id="22-hareware-independent-library">2.2 Hareware-Independent Library<a class="headerlink" href="#22-hareware-independent-library" title="Permanent link">&para;</a></h3>
<p>當我們對硬體相關的操作進行基本的抽象化之後，我們就可以利用 Hardware-Depedent Core Library 來建構其餘和硬體無關的細節部分。
如 I/O Library 和 Floating-Point Mmulation Library。</p>
<h4 id="221-io-library">2.2.1 I/O Library<a class="headerlink" href="#221-io-library" title="Permanent link">&para;</a></h4>
<p>正常來說，I/O Library 如 C 語言中的 <code>stdio.h</code> 應該要同時包含輸出和輸入的功能，如 <code>printf</code> 和 <code>scanf</code> 這兩個函式。
但是，因為實作輸入功能的話，會涉及到中斷（Interrupt）這個功能的實作，已經超出這份教材的範圍。因此，在這裡我們僅實作輸出相關功能。</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">io.h</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="cp">#ifndef __IO_H__</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="cp">#define __IO_H__</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="cm">/* basic output library */</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">putchar</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="kt">void</span><span class="w"> </span><span class="nf">puts</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="kt">void</span><span class="w"> </span><span class="nf">putint</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">integer</span><span class="p">);</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="kt">void</span><span class="w"> </span><span class="nf">printf</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="cp">#endif</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">io.c</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;../include/io.h&quot;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;../include/core.h&quot;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdarg.h&gt;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="cp">#define NOT_IMPLEMENTED                                                        \</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="cp">    do {                                                                       \</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="cp">        puts(&quot;Please implement the function by yourself!\n&quot;);                  \</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="cp">        terminate();                                                           \</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="cp">    } while (0);</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="kt">void</span><span class="w"> </span><span class="nf">putchar</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">platform_outb</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="kt">void</span><span class="w"> </span><span class="nf">puts</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">        </span><span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">++</span><span class="p">));</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="p">}</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="kt">void</span><span class="w"> </span><span class="nf">putint</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">numb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numb</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">        </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">        </span><span class="n">numb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">numb</span><span class="p">;</span><span class="w"> </span><span class="c1">// convert to positive number</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numb</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">        </span><span class="n">putint</span><span class="p">(</span><span class="n">numb</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">    </span><span class="n">putchar</span><span class="p">((</span><span class="n">numb</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="p">}</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32"></a>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="kt">void</span><span class="w"> </span><span class="nf">printf</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="w">    </span><span class="n">NOT_IMPLEMENTED</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">    </span><span class="c1">// TODO</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="222-integer-multiplication-and-division-emulation">2.2.2 Integer Multiplication and Division Emulation<a class="headerlink" href="#222-integer-multiplication-and-division-emulation" title="Permanent link">&para;</a></h4>
<p>因為在 RISC-V 的架構中，整數乘除法相關的指令是被定義在 <strong>M-Extension</strong> 當中，並不包含在 RV32/64I 當中，所以我們目前實作的 ISS 並不能直接執行整數乘除法相關的指令。但是，乘除法還有取模運算（Modulo Operation）在程式設計之中是相當常見的操作，如果限制我們的程式不能進行乘除法還有取模運算的話，會讓我們寫程式變得非常不方便和麻煩。但我們的 ISS 又只能執行加減法運算和常見的邏輯運算，那該怎麼辦？</p>
<p>本質上，乘除法還有模運算的背後也是加減法，因此利用加減法來<strong>模擬</strong>乘除法還有模運算是一件可以達成的事情。</p>
<div class="admonition note">
<p class="admonition-title">Simulation（模擬） vs. Emulation（仿真）</p>
<blockquote>
<p>在計算機科學中，simulation 和 emulation 這兩個詞雖然中文都可以被翻譯為「模擬」，但它們的具體含義和應用場景是不同的。這兩者的差異主要體現在它們的目標、實作方式以及應用情境上。</p>
<ol>
<li>Simulation（模擬）：
Simulation 是指使用軟體或硬體來模擬系統的行為，重點是模擬系統的功能和邏輯，而不一定完全忠實於系統的實際運作方式。模擬的目的是對系統的行為進行預測、測試或分析，不要求具備實際運行該系統的能力。</li>
<li>ISA Simulator: 例如當提到 ISA Simulator（指令集架構模擬器），指的是模擬一個處理器的指令集架構（ISA），讓我們可以在不同的硬體上執行該 ISA 定義的指令，觀察指令執行的結果。模擬器的重點在於模擬 CPU 的行為，例如指令的執行順序、計算結果等，但模擬器不需要在真實硬體上運行，也不必考慮實際硬體的時間精度或電路細節。</li>
<li>應用情境：模擬主要用於系統設計、驗證、性能分析等，例如處理器設計階段的指令集模擬、軟體開發階段的行為模擬等。這種方式可以幫助設計者在硬體還未完成之前就能進行測試。</li>
<li>Emulation（仿真）：
Emulation 則是指使用軟體或硬體來仿真另一個系統的功能與行為，並且讓它能夠忠實地執行原本應該在被仿真的系統上運行的軟體或硬體。仿真的目標是使系統「看起來」就像原系統一樣，能夠完全模擬它的功能，並且使得軟體和硬體在仿真環境中運行不會感知到差異。</li>
<li>Floating-Point Emulation: 當提到 Floating-Point Emulation（浮點數仿真），通常指的是使用軟體仿真來替代硬體實現浮點運算。當硬體不支持某些浮點指令時，軟體仿真器可以「模仿」硬體來執行這些浮點指令，使系統感覺不到這些運算其實是由軟體而非硬體完成的。</li>
<li>應用情境：仿真主要用於替代或復現某個系統的運作方式。例如，當新的處理器不再支援舊的指令集或硬體功能時，可以使用仿真技術讓舊的軟體仍能夠運行。另一個例子是遊戲機的仿真器，它可以讓不同硬體平台執行原來只能在遊戲機上運行的遊戲。</li>
</ol>
<p>Simulation 是側重於模擬系統的行為或邏輯運作，不需要完全重現系統的具體運行方式，通常用於設計和驗證階段。Emulation 是側重於忠實重現另一個系統的運行方式，讓其能夠運行原本專屬於該系統的軟體或硬體功能。因此，ISA Simulator 更偏向於提供處理器行為的模擬，以便進行測試和分析，而 Floating-Point Emulation 則是指當硬體無法支持某些浮點運算時，使用軟體來仿真其功能。</p>
<p>----- ChatGPT</p>
</blockquote>
</div>
<p>在這裡，因為我們使用的編譯器是 GCC（specially, RISC-V GNU Toolchain for RISC-V），而 GCC 正好提供了一個非常方便的功能，叫做 <a href="https://gcc.gnu.org/onlinedocs/gccint/Libgcc.html">The GCC low-level runtime library</a>（又稱 Libgcc），
我們可以借助其中的 <a href="https://gcc.gnu.org/onlinedocs/gccint/Integer-library-routines.html">Routines for integer arithmetic</a> 來完成整數乘除法和取模運算的模擬。</p>
<p>具體來說，Libgcc 針對硬體資源受限的硬體（e.g., 沒有內建整數乘除法器或 FPU）提供了許多方便的功能，讓硬體資源受限的硬體也可以執行更多樣的功能或運算。</p>
<blockquote>
<p>Most of the routines in libgcc handle arithmetic operations that the target processor cannot perform directly.
This includes integer multiply and divide on some machines, and all floating-point and fixed-point operations on other machines.
libgcc also includes routines for exception handling, and a handful of miscellaneous operations. <br>
----- GNU low-level runtime library</p>
</blockquote>
<p>我們正好可以利用 Libgcc 當中的 <strong>Routines for integer arithmetic</strong> 來將乘除法運算子還有取模運算（<code>*</code>, <code>/</code> and <code>%</code>）直接轉換成對應的函式呼叫，
讓我們實作的 ISS 即使沒有 M-extension 的支援也依然可以執行對應的運算。</p>
<p>對於轉寫 RISC-V Program 的人來說，其實這整件事情變得很簡單！因為這些 operator 到對應 function call 的轉換是由 Compiler 自動在背後完成的，
所以我們在撰寫程式的時候只要像往常一樣，直接使用我們想要用的 operators，最後在編譯的時候，在最後面加上 <code>-lgcc</code> 的 compilation flag 即可。
<code>-lgcc</code> 這個 flag 的用途是指示 GCC 要 link 到 Libgcc，這樣我們才可以使用 Libgcc 提供的功能。</p>
<h4 id="223-floating-point-emulation-library">2.2.3 Floating-Point Emulation Library<a class="headerlink" href="#223-floating-point-emulation-library" title="Permanent link">&para;</a></h4>
<p>在 RISC-V 當中浮點數相關的運算一樣是被歸類在擴充 <strong>F-Extension</strong> 當中，並沒有被歸類在 RV32/64I 當中，所以我們設計的 ISS 也無法<strong>直接以執行單一指令的方式</strong>進行浮點數相關的運算，因為我們並沒有實作 F-Extension 中所包含的指令，還有浮點數運算所需要的暫存器。</p>
<p>不過，浮點數運算本質上也是二進位的邏輯運算，因此我們是有辦法利用整數指令來模擬浮點數運算的。這也和我們前面提到我們所實作的指令集已經具備 Turing Complete 的性質有關。</p>
<h5 id="2231-why-floating-instead-of-fixed">2.2.3.1 Why Floating instead of Fixed?<a class="headerlink" href="#2231-why-floating-instead-of-fixed" title="Permanent link">&para;</a></h5>
<figure>
    <img alt="" src="https://hedgedoc.course.aislab.ee.ncku.edu.tw/uploads/a03398cd-3b0a-475c-bfe3-d8064b2426f7.png" />
</figure>
<p>大家之前學到以 Two's Complement 表示 Binary Integer 其實就屬於定點數運算（Fixed-Point Arithmetic）的一種，只不過差別在於我們的小數點是位於最後一個 Digit 的後面，所以並沒有小數的部分。更廣義的 Fixed-Point 通常是只同時包含 Integer Part 和 Fraction Part 的格式。但浮點數則不同於定點數，浮點數使用的是所謂的 Sign-Magnitude Representation，也就是把 Sign 和數值大小（絕對值）分成兩個部分來表示，兩個部分互不相關。更精確地來說，在 Floating-Point 中，Magnitude 的部分又拆分成 Exponent 加上 Mantisa 來表示，這種表示方式造成<strong>小數點的位置是浮動的</strong>，這也是浮點數這個名稱的由來。浮點數表示浮動的小數點。</p>
<p>我們必須要有一個認知是，實數有無限多個，所以不管是以定點數還是浮點數來說，一定都會有無法精確表示的數字，譬如 <span class="arithmatex">\(\frac{1}{3}\)</span> 不論是以定點數還是浮點數都無法精確地表示，我們只能<strong>近似表達</strong>。但既然這樣為什麼我們不使用定點數來進行小數運算就好？畢竟定點數使用二補數運算，在算數單元的設計上相較 Sign-Magnitude 表示形式更為簡單，因為 Two's Complement 可以直接進行相加，不用做任何額外的操作，但是浮點數的運算通常都需要進行額外的操作，譬如 Alignment 和 Normalization。</p>
<p>定點數最大的一個劣勢在於沒辦法很好地表示太大或是太接近零的數字，但是浮點數受益於使用 Exponent 加上 Mantisa 來表示數值大小（Magnitude），所以藉由控制 Exponent 我們可以很輕易地得到非常大的數字或是非常接近零<strong>但</strong>不等於零的數字。</p>
<figure>
    <img alt="" src="https://dwayneneed.github.io/static/img/2010-05-06-fun-with-floating-point_6bit-float-distribution.png" />
    <figcaption>Again, the horizontal axis is the naive interpretation of the 6 bits as an integer (though the sign is kept as a separate bit, rather than using two’s complement).
    The vertical axis is the actual floating point value represented by those bits, according the the IEEE-ish minifloat format we chose.<br>
    Source: <a href="https://dwayneneed.github.io/.net/2010/05/06/fun-with-floating-point.html">Fun with floating point</a>
    </figcaption>
</figure>
<p>不過，相較於定點數，浮點數有一個特性是數值的分布並不均勻。我們分成兩部分來討論，針對 Subnormal Floating-Point，因為 Exponent 固定為 <span class="arithmatex">\(-126\)</span>，在不考慮正負號的情況下唯一會影響數值大小的只有 Fraction。
所以，Subnormal 的數值分布其實是均勻地，均勻地分佈在實數軸上靠近零的地方。換句話說，某種程度上我們其實可以把 Subnormal 視為是定點數。
但是，對於 Normal Floating-Point 來說，Exponent 是會變動的，這也造成了當 Exponent 越來越大的時候（也代表離實數軸上原點越來越遠），Normal 的分布會越來越不平均，分布越來越離散。</p>
<h5 id="2232-ieee-754-single-precision-floating-point-binary32-format">2.2.3.2 IEEE 754 Single-Precision Floating-Point (Binary32) Format<a class="headerlink" href="#2232-ieee-754-single-precision-floating-point-binary32-format" title="Permanent link">&para;</a></h5>
<div class="admonition info">
<p class="admonition-title">IEEE 754-2008</p>
<p>文章中關於 Single-Precision Floating-Point 的介紹基於 IEEE 754-2008 的規範，詳細內容可以參考：<a href="https://ieeexplore.ieee.org/document/4610935">754-2008 - IEEE Standard for Floating-Point Arithmetic</a></p>
</div>
<p><img alt="" src="https://hedgedoc.course.aislab.ee.ncku.edu.tw/uploads/6a9992b2-d1d5-40c3-8dea-28f0646e5572.png" /></p>
<p>根據 IEEE 754 的規範，單精度浮點數的長度為 32-bit，其中 1-bit（MSB）作為 Sign-bit，8-bit 作為 Exponent，而最低的 23-bit 作為 Fraction。</p>
<ol>
<li>1-bit sign <span class="arithmatex">\(S\)</span></li>
<li>w-bit biased exponent <span class="arithmatex">\(E = e + \text{bias}\)</span></li>
<li><span class="arithmatex">\((t = p − 1)\)</span>-bit trailing significand field digit string <span class="arithmatex">\(T = d_1 d_2 ... d_{p-1}\)</span>; the leading bit of the significand, <span class="arithmatex">\(d_0\)</span>, is implicitly encoded in the biased exponent E.</li>
</ol>
<figure>
  <img alt="" src="../img/lab-3/754-param.png" width="850" />
</figure>
<p>對於 binary32 來說，bias 為 127，並且 <span class="arithmatex">\(e_{\text{max}} = 127\)</span>，而規格書也規定 <span class="arithmatex">\(e_{\text{min}} = 1 - e_{\text{max}} = -126\)</span>。</p>
<div class="admonition note">
<p class="admonition-title">Significand vs. Fraction</p>
<p>當我們講 Significand 的時候，指的是浮點數表示法中的 Fraction 加上 Implicit Leading 1。如果只有說 Fraction 的話就是單純只包含小數點後的部分，不包含 Leading 1。
在 IEEE 754 規格書中，又把 Fraction 稱為 Trailing Significand Field。</p>
</div>
<p>根據 IEEE 754 的規範，依照 Exponent 和 Fraction 的值的不同，可以有以下幾種情況：</p>
<div align="center">
<table>
<thead>
<tr>
<th style="text-align: center;">Value</th>
<th style="text-align: center;">Exponent</th>
<th style="text-align: center;">Fraction (Trailing Significand)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><span class="arithmatex">\(\pm 0\)</span></td>
<td style="text-align: center;">All zeros</td>
<td style="text-align: center;">All zeros</td>
</tr>
<tr>
<td style="text-align: center;">Normal</td>
<td style="text-align: center;">Not all zeros also not all ones</td>
<td style="text-align: center;">Arbitrary</td>
</tr>
<tr>
<td style="text-align: center;">Subnormal</td>
<td style="text-align: center;">All zeros</td>
<td style="text-align: center;">Not all zeros</td>
</tr>
<tr>
<td style="text-align: center;"><span class="arithmatex">\(\pm \infty\)</span></td>
<td style="text-align: center;">All ones</td>
<td style="text-align: center;">All zeros</td>
</tr>
<tr>
<td style="text-align: center;">NaN</td>
<td style="text-align: center;">All ones</td>
<td style="text-align: center;">Not all zeros</td>
</tr>
</tbody>
</table>
</div>
<p>需要特別注意的是，依照 IEEE 754 的規定，Exponent 的表示方式是 <span class="arithmatex">\(E = e + \text{bias}\)</span>，其中 <span class="arithmatex">\(E\)</span> 是加上 Bias 之後儲存在浮點數表示法中的 Exponent 數值，而 <span class="arithmatex">\(e\)</span> 是真實的 Exponent，而針對單精度浮點數來說，754 規定其 Bias 應為 127。
使用 Biased Representation (Offset Binary) 來表示 Exponent 其實是一個很巧妙的設計，我們知道單精度浮點數實際上可以表示的指數 <span class="arithmatex">\(e\)</span> 的範圍為 <span class="arithmatex">\(-126 \sim 127\)</span>，加上 Bias 之後我們可以發現 <span class="arithmatex">\(E\)</span> 一定是一個非負整數。
先忽略 Sign-bit 並且配合 Fraction，我們其實可以將 Exponent 和 Fraction 合起來視為一個無符號數整數，然後<strong>直接使用整數排序演算法來排序浮點數！</strong>，針對 Sign-bit 為 1 的狀況（也就是負數）只要將排序順序顛倒即可。 
所以使用 Offset Binary 來表示 Exponent 的好處就是我們可以不用再針對浮點數實作特殊的排序演算法，而是可以直接沿用整數排序演算法。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>請特別注意，Subnormal Number 的指數部分是 <span class="arithmatex">\(-126\)</span> 而非 <span class="arithmatex">\(-127\)</span>！</p>
</div>
<h5 id="2233-rouding-and-calculation-error">2.2.3.3 Rouding and Calculation Error<a class="headerlink" href="#2233-rouding-and-calculation-error" title="Permanent link">&para;</a></h5>
<div class="admonition note">
<p class="admonition-title">Keyword</p>
<ul>
<li>IEEE 754-2008</li>
<li>Infinite Precision</li>
<li>Guard, Round and Sticky Bit (GRS)</li>
<li>Units at the last bit (ulp)</li>
<li>Rounding Mode, Round-to-the-Nearest</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">參考</p>
<p><a href="https://www.acl.com.tw/specialinfo/expert_paper.php?p_id=4264">稽核分析中數字四捨五入的迷失? 你聽過「銀行家捨入法」嗎?</a></p>
</div>
<p>我們先來探討為什麼會出現 <strong>Round-to-Nearest</strong> 這種特殊的 rounding mode。
在中小學階段我們最常使用的是四捨五入這種方式，看似好像是一個相對公平的捨入方式，但實際上使用四捨五入相較於 IEEE 754 定義的 Round-to-the-Nearest 會引入較多的統計誤差。因為四捨五入對於要捨入的值剛好等於 0.5 的 Unit-in-the-last-place (ulp) 這種 <strong>tie-breaking case</strong> 來說，會像上捨入，意味著在這種狀況下值總是會無條件地變大，造成 Positive Bias。
以統計的觀點來看，我們總是會希望捨入後的平均值可以越接近原始值的平均值，這也是為什麼我們針對取捨的部分等於 0.5 ULP 的這種情況必須要做特別的討論，讓這種狀況有時候會 Round-up 而有時候會 Round-down，來抵銷統計上的 Bias。</p>
<p><img alt="" src="https://hedgedoc.course.aislab.ee.ncku.edu.tw/uploads/a68501ec-f240-46c4-bbc9-5654ed4e7eb6.png" /></p>
<p>在 IEEE 754 中其實總共規範了<strong>四種</strong> Rounding Mode，除了 <em>Round-to-Nearest</em> 之外，
還有 <em>Round-Torward-Positive</em>、<em>Round-Toward-Negative</em> 和 <em>Round-Toward-Zero</em>。並且 IEEE 754 規定<strong>預設的 Rounding Mode 應該為 Round-to-the-Nearest</strong>。但實際上在 IEEE 754 的規範中，Round-to-Nearest 又被細分成了兩種，分別是 <em>roundTiesToEven</em> 和 <em>roundTiesToAway</em>。
其中 roundTiesToAway 其實就是我們所熟悉的四捨五入的方式，而 roundTiesToEven 則是我們今天要討論的重點，也就是大家常說的 Round-to-Even。
roundTiesToEven 規定當我們遇到 tie-breaking case 的時候，必須要保持 LSB 永遠是 0（在這裡我們將 binary 中的 0 視為偶數，1 視為奇數）。
換句話說，在 tie-breaking case 中如果遇到 LSB 是 1 的話我們就必須 Round-up，因為這樣進位之後就可以使 LSB 變成 0。而當 LSB 是 0 的時候則直接 Round-down 以保持 LSB 依然為 0。</p>
<p>以浮點數加法為例，進行加法之前我們必須要將兩個數字依照 Exponent 進行對齊（alignment），如果我們使用手算的方式進行運算，只要我們願意把數字全部寫下來的話，那麼精度就不會損失！
但實際上在軟體或是硬體中，由於 Bits 數量有限，可能會損失一定的精度而造成誤差，但是如果我們因為這樣微小的誤差造成 Rounding 的結果不同，某些人算出來是需要 Round-down 但有些人是 Round-up 的話，這時候到底誰才是對的，又或者是說到底誰才是符合 IEEE 754 的規範？</p>
<div class="admonition note">
<p class="admonition-title">Definition</p>
<dl>
<dt><!-- word definition --></dt>
<dt><strong><em>Correct Rounding</em></strong></dt>
<dd>This standard’s method of converting an <strong>infinitely precise result</strong> to a floating-point number, as determined by the applicable rounding direction. A floating-point number so obtained is said to be correctly rounded.<br>----- IEEE 754-2008 Chapter 2 </dd>
</dl>
</div>
<p>其實在 IEEE 754 中，只針對何謂『正確的運算結果』做了詳細的規範，IEEE 754 並沒有規定你應該要如何實現運算的過程或是演算法的細節。IEEE 754 規範當我們對<strong>一個無限精度的結果</strong>進行捨入的話，所得到的結果就稱為正確的捨入結果（Correct Rounding）。
換句話說就是當我們在計算的過程中不損失任何精度（白話一點就是不捨棄任何 Bits/Digits），然後再以這樣計算的結果做 Rounding 的話，就認定這樣的結果是正確的結果。
但因為要強迫計算過程中不能損失任何精度的話，不論是軟體或是硬體上都會有比較大的 overhead，以我們目前探討單精度浮點數說，看起來可能還好，因為兩個<strong>正規（Normal）</strong>浮點數的 Exponent 最多相差 <span class="arithmatex">\(127 - (-126) = 253\)</span>，所以我們只要使用 253-bit 的 extra-bits 即可保證運算過程中不損失任何精度。
但是，如果我們今天需要用到雙倍精度（Double Precision）甚至是四倍精度（Quad Precision）的時候，就會需要使用非常非常多的 extra-bits，這樣做的成本非常高。</p>
<blockquote>
<p>Since the worst case for rounding would be when the actual number is halfway between two floating-point representations, accuracy in floating point is normally measured in terms of the number of bits in error in the least significant bits of the significand;
the measure is called the number of units in the last place, or ulp. If a number were off by 2 in the least significant bits, it would be called off by 2 ulps.
Provided there are no overflow, underflow, or invalid operation exceptions, IEEE 754 guarantees that the computer uses the number that is within one-half ulp. <br>
----- Computer Organization and Design RISC-V Edition: The Hardware/Software Interface<sup id="fnref4:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
</blockquote>
<p>根據課本<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>上的描述，會導致 Rounding 過後的結果和原始結果有最大誤差的狀況就是當原始結果剛好介於兩個浮點數表示之間（Floating-Poing Representation），因此我們常常會用 <strong><em>Units in the last place (ulp)</em></strong> 來衡量絕對誤差的大小。
舉例來說，假設不損失精度的計算結果為 <span class="arithmatex">\(1.01011_{\text{two}}\)</span>，而我們的有效位數只到小數點後兩位，那假設捨入後結果為 <span class="arithmatex">\(1.01_{\text{two}}\)</span>，則我們可以說這個運算的誤差為 <span class="arithmatex">\(0.375\)</span> 個 ulp。
<strong>只要我們可以遵守 IEEE 754 的規範，也就是只要我們保證我們的結果是 Correct Rounding 的話，那麼誤差最多就只會是 <span class="arithmatex">\(\frac{1}{2}\)</span> 個 ulp。</strong></p>
<div class="admonition note">
<p class="admonition-title">Definition</p>
<dl>
<dt><strong><em>Units in the last place (ULP)</em></strong></dt>
<dd>The number of bits in error in the least significant bits of the significand between the actual number and the number that can be represented.</dd>
<dd>If the exponent range is not upper-bounded, a ULP value of a floating-point number x is the distance between the two closest straddling floating-point numbers a and b nearest to x. The IEEE 754 standard requires that the result of an elementary arithmetic operation such as addition, multiplication, or division is correctly rounded. A correctly rounded result means that the rounded result is within 0.5 ULP of the exact result.</dd>
</dl>
</div>
<p>所以，比起在運算過程中不損失任何精度，有沒有一種方法是<strong>在保證不影響 Rounding 結果的前提下捨棄部分精度</strong>，讓實作的成本更小、更簡單？
這種方法就是我們在課堂上所講的 <strong><em>Guard, Round and Sticky Bit (GRS)</em></strong>。根據課本<sup id="fnref2:1"><a class="footnote-ref" href="#fn:1">1</a></sup>上的定義：</p>
<div class="admonition note">
<p class="admonition-title">Definition</p>
<dl>
<dt><strong><em>Guard Bit</em></strong></dt>
<dd>The first of two extra bits kept on the right during intermediate calculations of floating-point numbers; used to improve rounding accuracy.</dd>
<dt><strong><em>Round Bit</em></strong></dt>
<dd>the name of the second of two extra bits kept on the right during intermediate floating-point calculations, which improves rounding accuracy.</dd>
<dt><strong><em>Sticky Bit</em></strong></dt>
<dd>A bit used in rounding in addition to guard and round that is set whenever there are nonzero bits to the right of the round bit.</dd>
</dl>
</div>
<p>使用 GRS 可以讓我們可以在計算的過程中，僅僅需要保留 3 個 extra-bits，但是卻可以得到和不損失任何精度的計算結果一樣的 Rounding 結果。</p>
<div align="center">
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>G</strong></th>
<th style="text-align: center;"><strong>R</strong></th>
<th style="text-align: center;"><strong>S</strong></th>
<th style="text-align: center;"><strong>Rounding Direction</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-down</td>
</tr>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Round-down</td>
</tr>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-down</td>
</tr>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Round-down</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-up when LSB equaling 1<br> otherwise Round-down</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Round-up</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-up</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Round-up</td>
</tr>
</tbody>
</table>
</div>
<p>透過觀察其實可以發現我們可以將 Round Bit 和 Sticky Bit 再做 OR，得到更簡約的判斷條件。</p>
<div align="center">
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>G</strong></th>
<th style="text-align: center;"><strong>R | S</strong></th>
<th style="text-align: center;"><strong>Rounding Direction</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-down</td>
</tr>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-down</td>
</tr>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-down</td>
</tr>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-down</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round-up when LSB equaling 1<br> otherwise Round-down</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Round-up</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Round-up</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Round-up</td>
</tr>
</tbody>
</table>
</div>
<p>其實重點在於 Sticky Bit 的實作；根據課本<sup id="fnref3:1"><a class="footnote-ref" href="#fn:1">1</a></sup>對於 Sticky Bit 的定義，Sticky Bit 是只要當 Round Bit 的右側的所有 Bit 只要出現任何一個 1 的話，那麼 Sticky Bit 就是 1，否則 Sticky Bit 就是 0。
這種操作又稱為 <strong>Reduction Operation</strong>，在 Verilog 中可以直接使用 Reduction Operator，但是 C 語言的話就必須自己實作。
在使用 Extra-bit 來輔助 Rounding 的時候，我們不可以直接使用 <strong>Trouncate</strong>（截斷）的方式來獲得 Sticky Bit。
舉例來說，假設我們的浮點數運算結果是 <span class="arithmatex">\(1.101001_{\text{two}}\)</span>，且有效位數到小數點後第二位（即 LSB 的位置為小數點後第二位），
當我們想要使用 GRS 來輔助 Rounding 的時候，有些人可能會做錯，直接捨棄掉 LSB 後三位之後的所有數字，得到 <span class="arithmatex">\(G = 1\)</span>、<span class="arithmatex">\(R = 0\)</span> 且 <span class="arithmatex">\(S = 0\)</span>，因此將結果 Round-down（因為 LSB 是 0），得到 <span class="arithmatex">\(1.10_{\text{two}}\)</span>。
但是，正確的結果應該是 <span class="arithmatex">\(G = 1\)</span>、<span class="arithmatex">\(R = 0\)</span> 且 <span class="arithmatex">\(S = 1\)</span>，因為 Round Bit 的後面其實出現了一個 1（小數點後第六位），依照 Sticky Bit 的定義（對 Sticky Bit 以後的所有 Bit 做 Unary OR）來說的話應該要把 S 設為 1。如果依照 GRS 等於 101 來判斷的話，我們應該要將結果 Round-up，得到 <span class="arithmatex">\(1.11_{\text{two}}\)</span>。
依照 IEEE 754 的規範來說，<span class="arithmatex">\(1.11_{\text{two}}\)</span> 才是正確的捨入結果（Correct Rounding）。</p>
<div class="admonition info">
<p class="admonition-title">補充：Kahan Summation Algorithm</p>
<p>Kahan Summation，或稱為 Kahan 補償加法，是一種在浮點數加法中提升精度的算法，由 William Kahan 發明。
此方法主要用於累加大量浮點數時，避免因浮點數誤差（如捨入誤差）而導致最終結果偏差過大的問題。
當對大量浮點數累加時，數值較小的浮點數在加入數值較大的累加和時，容易因為浮點數表示的精度有限而導致誤差。
例如，若和的大小遠大於接下來要加入的數字，則加入的數可能會因精度限制而被捨棄或產生較大誤差。
Kahan summation 提供了補償機制，以記錄並補償這些捨入誤差。</p>
<p>在某些場景當中運算的準確度是至關重要的，像是物理模擬或是經融計算的應用，只要累積一定的誤差往往就會對結果產生很大的影響。
但是計算用的電腦往往也都是採用浮點數進行計算，引入誤差是無可避免的事情，因此需要發展出特定的演算法來補償（Compensate）這些誤差，使計算結果更貼近真實情況。</p>
<p>參考：<a href="https://en.wikipedia.org/wiki/Kahan_summation_algorithm">Wikipedia - Kahan summation algorithm</a></p>
</div>
<h5 id="2234-implementation">2.2.3.4 Implementation<a class="headerlink" href="#2234-implementation" title="Permanent link">&para;</a></h5>
<p>我們以 RISC-V F-Extension 為例，常見的浮點數運算包含加減乘除還有開平方根（Square-Root）運算，在這裡我只討論浮點數加減法的運算。
雖然以演算法的觀點來說，浮點數加減法的運算不會很複雜，但是在實作上其實還是有很多細節需要注意，並且也有很多技巧可以加快運算速度。</p>
<div class="admonition info">
<p class="admonition-title">Berkeley SoftFloat Release 3e</p>
<p><a href="https://github.com/ucb-bar/berkeley-softfloat-3"><strong>ucb-bar/berkeley-softfloat-3</strong></a></p>
<p>Berkeley SoftFloat is a software implementation of binary floating-point that conforms to the IEEE Standard for Floating-Point Arithmetic.
SoftFloat is distributed in the form of C source code.
Building the SoftFloat sources generates a library file (typically softfloat.a or libsoftfloat.a) containing the floating-point subroutines.</p>
<p><strong>以下的程式碼主要參考 Berkeley SoftFloat 3 的實作，並且做了必要的簡化</strong>。</p>
</div>
<p>針對加法和減法的運算，我們其實可以用另外一種觀點來詮釋。對於加法運算，根據兩個 Operands 的 Sign-Bit 我們可以把問題區分成 Magnitude 相加、相減兩種情況，並且在額外判斷結果的 Sign-Bit 即可。
討論浮點數加法運算 <span class="arithmatex">\(A + B = C\)</span>：</p>
<ol>
<li>當 <span class="arithmatex">\(A\)</span> 和 <span class="arithmatex">\(B\)</span> 同號（same sign）： <span class="arithmatex">\(\text{mag}\left(A + B\right) = \text{mag}\left(A\right) + \text{mag}\left(B\right) = \text{mag}\left(C\right)\)</span><ul>
<li>直接把 <span class="arithmatex">\(A\)</span> 或 <span class="arithmatex">\(B\)</span> 的 Sign-Bit 作為 <span class="arithmatex">\(C\)</span> 的 Sign-Bit 即可</li>
</ul>
</li>
<li>當 <span class="arithmatex">\(A\)</span> 和 <span class="arithmatex">\(B\)</span> 異號（contrary sign）：<span class="arithmatex">\(\text{mag}\left(A + B\right) = |\text{mag}\left(A\right) - \text{mag}\left(B\right)| = \text{mag}\left(C\right)\)</span><ul>
<li>如果 <span class="arithmatex">\(\text{exp}\left(A\right) = \text{exp}\left(B\right)\)</span><ul>
<li>如果 <span class="arithmatex">\(\text{mag}\left(A\right) \geq \text{mag}\left(B\right)\)</span>，則 <span class="arithmatex">\(\text{sign}\left(C\right) = \text{sign}\left(A\right)\)</span>，反之則 <span class="arithmatex">\(\text{sign}\left(C\right) = \text{sign}\left(B\right)\)</span></li>
</ul>
</li>
<li>如果 <span class="arithmatex">\(\text{exp}\left(A\right) &gt; \text{exp}\left(B\right)\)</span><ul>
<li>則 <span class="arithmatex">\(\text{sign}\left(C\right) = \text{sign}\left(A\right)\)</span></li>
</ul>
</li>
<li>如果 <span class="arithmatex">\(\text{exp}\left(A\right) &lt; \text{exp}\left(B\right)\)</span><ul>
<li>則 <span class="arithmatex">\(\text{sign}\left(C\right) = \text{sign}\left(B\right)\)</span></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>而針對減法運算，我們可以利用公式 <span class="arithmatex">\(A - B = A + \left(-B\right)\)</span> 即可將減法問題變換為加法問題。其中，要將一個浮點數變號非常簡單，只要將其 Sign-Bit 翻轉（flip）即可。
然而，在實作上，因為要考慮各式各樣運算過程中或是運算後可能會產生的問題，其實會導致程式碼變得相對複雜很多。</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Header file</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="cp">#ifndef __FP_H__</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="cp">#define __FP_H__</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdbool.h&gt;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;stdint.h&quot;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="cm">/*</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="cm"> * utilize bit-field to extract sign, exponent and fraction of a fp</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="cm"> * Ps: it is related to big/little-endian</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="cm"> */</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="cm">/* the order of bit-fields is important */</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">frac</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">23</span><span class="p">;</span><span class="w">    </span><span class="c1">// 23-bit fraction</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">exponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="c1">// 8-bit exponent</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">sign</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">         </span><span class="c1">// a-bit sign</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="p">}</span><span class="w"> </span><span class="n">f32_field</span><span class="p">;</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="cm">/*</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="cm"> * union type contains uint32_t, float and f32_field,</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="cm"> * for easy bit string manipulation</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="cm"> */</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ui32</span><span class="p">;</span><span class="w">   </span><span class="c1">// raw bit-string</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">f32</span><span class="p">;</span><span class="w">       </span><span class="c1">// single-precision float</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="w">    </span><span class="n">f32_field</span><span class="w"> </span><span class="n">field</span><span class="p">;</span><span class="w"> </span><span class="c1">// float-type integer</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="p">}</span><span class="w"> </span><span class="n">ui32_f32</span><span class="p">;</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a><span class="k">extern</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">exceptionFlags</span><span class="p">;</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="k">extern</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">f32_add</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="k">extern</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">f32_sub</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="k">extern</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">f32_neg</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a><span class="k">extern</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">f32_abs</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="cp">#endif</span>
</span></code></pre></div></td></tr></table></div>
<p>對於使用這個 library 的使用者來說，可以直接使用 <code>f32_</code> 開頭的這四個函式來做浮點數計算。目前考慮到難易度，所以我們只實作了加減、取反數和絕對值這四種運算。
除此之外，我們也可以使用 <code>ui32_f32</code> 這個特殊的 data type 來建構浮點數。</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Helper Functions</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">  1</a></span>
<span class="normal"><a href="#__codelineno-13-2">  2</a></span>
<span class="normal"><a href="#__codelineno-13-3">  3</a></span>
<span class="normal"><a href="#__codelineno-13-4">  4</a></span>
<span class="normal"><a href="#__codelineno-13-5">  5</a></span>
<span class="normal"><a href="#__codelineno-13-6">  6</a></span>
<span class="normal"><a href="#__codelineno-13-7">  7</a></span>
<span class="normal"><a href="#__codelineno-13-8">  8</a></span>
<span class="normal"><a href="#__codelineno-13-9">  9</a></span>
<span class="normal"><a href="#__codelineno-13-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-13-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-13-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-13-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-13-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-13-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-13-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-13-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-13-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-13-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-13-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-13-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-13-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-13-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-13-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-13-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-13-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-13-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-13-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-13-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-13-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-13-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-13-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-13-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-13-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-13-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-13-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-13-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-13-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-13-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-13-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-13-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-13-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-13-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-13-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-13-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-13-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-13-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-13-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-13-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-13-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-13-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-13-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-13-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-13-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-13-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-13-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-13-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-13-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-13-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-13-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-13-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-13-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-13-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-13-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-13-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-13-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-13-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-13-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-13-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-13-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-13-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-13-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-13-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-13-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-13-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-13-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-13-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-13-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-13-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-13-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-13-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-13-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-13-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-13-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-13-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-13-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-13-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-13-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-13-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-13-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-13-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-13-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-13-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-13-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-13-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-13-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-13-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-13-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-13-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-13-100">100</a></span>
<span class="normal"><a href="#__codelineno-13-101">101</a></span>
<span class="normal"><a href="#__codelineno-13-102">102</a></span>
<span class="normal"><a href="#__codelineno-13-103">103</a></span>
<span class="normal"><a href="#__codelineno-13-104">104</a></span>
<span class="normal"><a href="#__codelineno-13-105">105</a></span>
<span class="normal"><a href="#__codelineno-13-106">106</a></span>
<span class="normal"><a href="#__codelineno-13-107">107</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdbool.h&gt;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="c1">// #include &lt;stdio.h&gt;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;fp.h&quot;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="cm">/* initialize exception flags */</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">exceptionFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="cm">/* flag types enumeration */</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="n">flag_inexact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">    </span><span class="n">flag_underflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">    </span><span class="n">flag_overflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">    </span><span class="n">flag_infinite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">    </span><span class="n">flag_invalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="p">}</span><span class="w"> </span><span class="n">exceptionFlag_t</span><span class="p">;</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="cm">/* function to raise flags */</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">raiseFlags</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">exceptionFlags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="cm">/* countLeadingZero8 can be viewed as a Look-Up Table (LUT) */</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint_least8_t</span><span class="w"> </span><span class="n">countLeadingZeros8</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="w">    </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="w">    </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="cm">/*</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34"></a><span class="cm"> * countLeadingZeros32 takes the advantage of countLeadingZeros8</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="cm"> * to spped up the counting process</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="cm"> */</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">countLeadingZeros32</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="w">    </span><span class="kt">uint_fast8_t</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40"></a><span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41"></a><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x1000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44"></a><span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45"></a><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47"></a><span class="w">    </span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">countLeadingZeros8</span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">];</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49"></a><span class="p">}</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50"></a>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51"></a><span class="cm">/*----------------------------------------------------------------------------</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52"></a><span class="cm">| Shifts &#39;a&#39; right by the number of bits given in &#39;dist&#39;, which must not</span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53"></a><span class="cm">| be zero.  If any nonzero bits are shifted off, they are &quot;jammed&quot; into the</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54"></a><span class="cm">| least-significant bit of the shifted value by setting the least-significant</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55"></a><span class="cm">| bit to 1.  This shifted-and-jammed value is returned.</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56"></a><span class="cm">|   The value of &#39;dist&#39; can be arbitrarily large.  In particular, if &#39;dist&#39; is</span>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57"></a><span class="cm">| greater than 32, the result will be either 0 or 1, depending on whether &#39;a&#39;</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58"></a><span class="cm">| is zero or nonzero.</span>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59"></a><span class="cm">*----------------------------------------------------------------------------*/</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">shiftRightJam32</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">dist</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">dist</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">31</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62"></a><span class="w">                       </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63"></a><span class="p">}</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64"></a>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65"></a><span class="cm">/*</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66"></a><span class="cm"> * basically, the sig should be a 23-bit value</span>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67"></a><span class="cm"> * but here is a trick that</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68"></a><span class="cm"> * the overflow part of sig will be added to the exp</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69"></a><span class="cm"> * which reduces the complexity of calculation</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70"></a><span class="cm"> * by removing additional shifting and addition</span>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71"></a><span class="cm"> */</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">packToF32UI</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">sign</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(((</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">sign</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">23</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74"></a><span class="p">}</span>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75"></a>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76"></a><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">roundPackToF32</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">sign</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">roundIncrement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="n">roundBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7F</span><span class="p">;</span>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78"></a>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79"></a><span class="w">    </span><span class="cm">/* add 0.5 ULP and trouncate extra-bits */</span>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80"></a><span class="w">    </span><span class="n">sig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sig</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">roundIncrement</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">roundBits</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82"></a><span class="w">        </span><span class="n">raiseFlags</span><span class="p">(</span><span class="n">flag_inexact</span><span class="p">);</span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84"></a><span class="w">    </span><span class="cm">/* adjust LSB if it&#39;s tie-breaking case */</span>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85"></a><span class="w">    </span><span class="n">sig</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="o">!</span><span class="p">(</span><span class="n">roundBits</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x40</span><span class="p">));</span>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87"></a><span class="w">        </span><span class="n">exp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-88"><a id="__codelineno-13-88" name="__codelineno-13-88"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-89"><a id="__codelineno-13-89" name="__codelineno-13-89"></a>
</span><span id="__span-13-90"><a id="__codelineno-13-90" name="__codelineno-13-90"></a><span class="w">    </span><span class="n">ui32_f32</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-13-91"><a id="__codelineno-13-91" name="__codelineno-13-91"></a><span class="w">    </span><span class="n">ret</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packToF32UI</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">);</span>
</span><span id="__span-13-92"><a id="__codelineno-13-92" name="__codelineno-13-92"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">f32</span><span class="p">;</span>
</span><span id="__span-13-93"><a id="__codelineno-13-93" name="__codelineno-13-93"></a><span class="p">}</span>
</span><span id="__span-13-94"><a id="__codelineno-13-94" name="__codelineno-13-94"></a>
</span><span id="__span-13-95"><a id="__codelineno-13-95" name="__codelineno-13-95"></a><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">normRoundPackToF32</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">sign</span><span class="p">,</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-96"><a id="__codelineno-13-96" name="__codelineno-13-96"></a><span class="w">    </span><span class="kt">int8_t</span><span class="w"> </span><span class="n">shiftDist</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-13-97"><a id="__codelineno-13-97" name="__codelineno-13-97"></a><span class="w">        </span><span class="n">countLeadingZeros32</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// minus 1 because of using only 31-bit</span>
</span><span id="__span-13-98"><a id="__codelineno-13-98" name="__codelineno-13-98"></a><span class="w">    </span><span class="n">ui32_f32</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
</span><span id="__span-13-99"><a id="__codelineno-13-99" name="__codelineno-13-99"></a>
</span><span id="__span-13-100"><a id="__codelineno-13-100" name="__codelineno-13-100"></a><span class="w">    </span><span class="n">exp</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">shiftDist</span><span class="p">;</span>
</span><span id="__span-13-101"><a id="__codelineno-13-101" name="__codelineno-13-101"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="mi">7</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shiftDist</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">exp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0xFD</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-102"><a id="__codelineno-13-102" name="__codelineno-13-102"></a><span class="w">        </span><span class="n">z</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packToF32UI</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">exp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">shiftDist</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">7</span><span class="p">));</span>
</span><span id="__span-13-103"><a id="__codelineno-13-103" name="__codelineno-13-103"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-104"><a id="__codelineno-13-104" name="__codelineno-13-104"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">roundPackToF32</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span><span class="w"> </span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">shiftDist</span><span class="p">);</span>
</span><span id="__span-13-105"><a id="__codelineno-13-105" name="__codelineno-13-105"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-106"><a id="__codelineno-13-106" name="__codelineno-13-106"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">f32</span><span class="p">;</span>
</span><span id="__span-13-107"><a id="__codelineno-13-107" name="__codelineno-13-107"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>接下來我們定義了數個 Helper Fuction 用來作為主要計算過程中的輔助函式。
其中有三個部分比較特別，分別是 <code>countLeadingZeros32</code>、<code>shiftRightJam32</code> 和 <code>roundPackTo32</code>，我們以下來一一探討這三個 Function 的功能和特別之處。</p>
<p>首先是 <code>countLeadingZeros32</code>，這個函數用來計算一個 32-bit binray 的 Leading-Zeros。基本上這個函式在實作的概念上應該不會難，以下示範一種 naive 的實作方式。 </p>
<div class="admonition info">
<p class="admonition-title">名詞：Naive Implementation</p>
<p>參考：<a href="https://www.sciencedirect.com/topics/computer-science/naive-implementation">SienceDirect - Naive Implementation</a></p>
<dl>
<dt><strong><em>Naive Implementation</em></strong></dt>
<dd>A naive implementation, in the context of Computer Science, refers to a simple and straightforward approach to implementing a concept or algorithm, often using basic techniques and hardware. It involves performing operations one at a time, which may result in slower speeds compared to more optimized implementations.</dd>
</dl>
</div>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Naive Imepletation for counting leading-zeros</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span>
<span class="normal"><a href="#__codelineno-14-7">7</a></span>
<span class="normal"><a href="#__codelineno-14-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">countLeadingZeros32</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">        </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>不過因為使用 software-based 的方式來模擬浮點數運算本身就已經很慢了，因此在 Berkeley Softfloat 中，利用了 Look-Up Table 的方式來對計算過程進行加速。
大致上來說，先利用兩次的 if-statement 做初步地判斷，最後再直接以查表的方式計算，在查表時只需計算 8-bit binary 的 leading-zeros 數量。</p>
<p>再來是 <code>shiftRightJam</code>，這個函式其實就是負責執行<strong>邏輯</strong>右移操作（Logical Right-Shifting），但特別之處在於它多了 Jamming 操作。
還記得前面我們說，為了使運算後捨入的結果為正確結果，我們必須利用 GRS 這三個 extra-bit 來輔助運算，其中 Sticky Bit 必須要使用 Reduced-OR 的方式來實作，而 Jamming 操作指的就是這個部分。</p>
<p>最後是 <code>roundPackToF32</code> 這個函式，這個函式的主要功能是將給定的 Sign、Exponent 和 Significand（注意，不是 Fraction）經過 Rounding 之後，再轉換成 FP32 的格式。
正常來說，IEEE 754 的規範規定了對於 Normal Number 來說，我們只需要儲存 Significand 中 Fraction 的部分，將 Leading-one 省略，變成 Implicit Leading-one。
而對於 Subnormal Number 來說，不會有 Leading-one 的存在，在數值上也僅有 Fraction 的部分。
在 <code>roudPackToF32</code> 中，如果我們又依照傳入的 Exponent 和 Significand 來判斷該數是 Normal 還是 Subnormal 然後決定該如果轉換格式，會造成額外的開銷。
注意到，根據 <code>packToF32UI</code> 這個函式的實作來說，其實 Significand 多出來的 Leading-one（i.e., 24-th bit）其實可以直接視為 Overflow 並且會被直接加到 Exponent 當中。
也因此我們在實作上不用再額外判斷 Normal/Subnormal，只要直接呼叫 <code>packToF32UI</code> 即可。</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Magnitude Addition</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span>
<span class="normal"><a href="#__codelineno-15-32">32</a></span>
<span class="normal"><a href="#__codelineno-15-33">33</a></span>
<span class="normal"><a href="#__codelineno-15-34">34</a></span>
<span class="normal"><a href="#__codelineno-15-35">35</a></span>
<span class="normal"><a href="#__codelineno-15-36">36</a></span>
<span class="normal"><a href="#__codelineno-15-37">37</a></span>
<span class="normal"><a href="#__codelineno-15-38">38</a></span>
<span class="normal"><a href="#__codelineno-15-39">39</a></span>
<span class="normal"><a href="#__codelineno-15-40">40</a></span>
<span class="normal"><a href="#__codelineno-15-41">41</a></span>
<span class="normal"><a href="#__codelineno-15-42">42</a></span>
<span class="normal"><a href="#__codelineno-15-43">43</a></span>
<span class="normal"><a href="#__codelineno-15-44">44</a></span>
<span class="normal"><a href="#__codelineno-15-45">45</a></span>
<span class="normal"><a href="#__codelineno-15-46">46</a></span>
<span class="normal"><a href="#__codelineno-15-47">47</a></span>
<span class="normal"><a href="#__codelineno-15-48">48</a></span>
<span class="normal"><a href="#__codelineno-15-49">49</a></span>
<span class="normal"><a href="#__codelineno-15-50">50</a></span>
<span class="normal"><a href="#__codelineno-15-51">51</a></span>
<span class="normal"><a href="#__codelineno-15-52">52</a></span>
<span class="normal"><a href="#__codelineno-15-53">53</a></span>
<span class="normal"><a href="#__codelineno-15-54">54</a></span>
<span class="normal"><a href="#__codelineno-15-55">55</a></span>
<span class="normal"><a href="#__codelineno-15-56">56</a></span>
<span class="normal"><a href="#__codelineno-15-57">57</a></span>
<span class="normal"><a href="#__codelineno-15-58">58</a></span>
<span class="normal"><a href="#__codelineno-15-59">59</a></span>
<span class="normal"><a href="#__codelineno-15-60">60</a></span>
<span class="normal"><a href="#__codelineno-15-61">61</a></span>
<span class="normal"><a href="#__codelineno-15-62">62</a></span>
<span class="normal"><a href="#__codelineno-15-63">63</a></span>
<span class="normal"><a href="#__codelineno-15-64">64</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">addMag_F32</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">uiA</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">uiB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">    </span><span class="n">ui32_f32</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uiA</span><span class="p">;</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="n">b</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uiB</span><span class="p">;</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">expA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">exponent</span><span class="p">;</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">expB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">exponent</span><span class="p">;</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sigA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">frac</span><span class="p">;</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sigB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">frac</span><span class="p">;</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">signZ</span><span class="p">;</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">expZ</span><span class="p">;</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sigZ</span><span class="p">;</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">expDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">expB</span><span class="p">;</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">expDiff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">        </span><span class="cm">/* A and B have the same exponents */</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">expA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="w">            </span><span class="cm">/* exponents of A and B are zero (subnormal) */</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">            </span><span class="n">z</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uiA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sigB</span><span class="p">;</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">uiz</span><span class="p">;</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="w">        </span><span class="cm">/* A and B are normal number */</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="w">        </span><span class="n">signZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">sign</span><span class="p">;</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="w">        </span><span class="n">expZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expA</span><span class="p">;</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="w">        </span><span class="n">sigZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x01000000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sigA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sigB</span><span class="p">;</span><span class="w"> </span><span class="c1">// contain &quot;two&quot; implicit leading 1</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sigZ</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">expZ</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0xFE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">            </span><span class="cm">/* check whether it can be normalized */</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="w">            </span><span class="n">z</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packToF32UI</span><span class="p">(</span><span class="n">signZ</span><span class="p">,</span><span class="w"> </span><span class="n">expZ</span><span class="p">,</span><span class="w"> </span><span class="n">sigZ</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// without rounding</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">uiz</span><span class="p">;</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33"></a><span class="w">        </span><span class="n">sigZ</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35"></a><span class="w">        </span><span class="cm">/* A and B have the different exponents */</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36"></a><span class="w">        </span><span class="n">signZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">sign</span><span class="p">;</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37"></a><span class="w">        </span><span class="cm">/* keep 6 extra-bits befor starting calculating */</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38"></a><span class="w">        </span><span class="n">sigA</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39"></a><span class="w">        </span><span class="n">sigB</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">expDiff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41"></a><span class="w">            </span><span class="cm">/* align to A */</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42"></a><span class="w">            </span><span class="cm">/* A must be normal FP */</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43"></a><span class="w">            </span><span class="n">expZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expA</span><span class="p">;</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44"></a><span class="w">            </span><span class="n">sigB</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">expB</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0x20000000</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sigB</span><span class="p">;</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45"></a><span class="w">            </span><span class="n">sigB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shiftRightJam32</span><span class="p">(</span><span class="n">sigB</span><span class="p">,</span><span class="w"> </span><span class="n">expDiff</span><span class="p">);</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47"></a><span class="w">            </span><span class="cm">/* align to B */</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48"></a><span class="w">            </span><span class="cm">/* B must be normal FP */</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49"></a><span class="w">            </span><span class="n">expZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expB</span><span class="p">;</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50"></a><span class="w">            </span><span class="n">sigA</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">expA</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0x20000000</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sigA</span><span class="p">;</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51"></a><span class="w">            </span><span class="n">sigA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shiftRightJam32</span><span class="p">(</span><span class="n">sigA</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">expDiff</span><span class="p">);</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53"></a><span class="w">        </span><span class="n">sigZ</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54"></a><span class="w">            </span><span class="mh">0x20000000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sigA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sigB</span><span class="p">;</span><span class="w"> </span><span class="c1">// contain only &quot;one&quot; implicit leading 1</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55"></a><span class="w">        </span><span class="cm">/* check and normalize */</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sigZ</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x40000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57"></a><span class="w">            </span><span class="n">expZ</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58"></a><span class="w">            </span><span class="n">sigZ</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">roundPackToF32</span><span class="p">(</span><span class="n">signZ</span><span class="p">,</span><span class="w"> </span><span class="n">expZ</span><span class="p">,</span><span class="w"> </span><span class="n">sigZ</span><span class="p">);</span><span class="w"> </span><span class="c1">// round and pack</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62"></a><span class="nl">uiz</span><span class="p">:</span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">f32</span><span class="p">;</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Magnitude Substraction</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span>
<span class="normal"><a href="#__codelineno-16-44">44</a></span>
<span class="normal"><a href="#__codelineno-16-45">45</a></span>
<span class="normal"><a href="#__codelineno-16-46">46</a></span>
<span class="normal"><a href="#__codelineno-16-47">47</a></span>
<span class="normal"><a href="#__codelineno-16-48">48</a></span>
<span class="normal"><a href="#__codelineno-16-49">49</a></span>
<span class="normal"><a href="#__codelineno-16-50">50</a></span>
<span class="normal"><a href="#__codelineno-16-51">51</a></span>
<span class="normal"><a href="#__codelineno-16-52">52</a></span>
<span class="normal"><a href="#__codelineno-16-53">53</a></span>
<span class="normal"><a href="#__codelineno-16-54">54</a></span>
<span class="normal"><a href="#__codelineno-16-55">55</a></span>
<span class="normal"><a href="#__codelineno-16-56">56</a></span>
<span class="normal"><a href="#__codelineno-16-57">57</a></span>
<span class="normal"><a href="#__codelineno-16-58">58</a></span>
<span class="normal"><a href="#__codelineno-16-59">59</a></span>
<span class="normal"><a href="#__codelineno-16-60">60</a></span>
<span class="normal"><a href="#__codelineno-16-61">61</a></span>
<span class="normal"><a href="#__codelineno-16-62">62</a></span>
<span class="normal"><a href="#__codelineno-16-63">63</a></span>
<span class="normal"><a href="#__codelineno-16-64">64</a></span>
<span class="normal"><a href="#__codelineno-16-65">65</a></span>
<span class="normal"><a href="#__codelineno-16-66">66</a></span>
<span class="normal"><a href="#__codelineno-16-67">67</a></span>
<span class="normal"><a href="#__codelineno-16-68">68</a></span>
<span class="normal"><a href="#__codelineno-16-69">69</a></span>
<span class="normal"><a href="#__codelineno-16-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">subMag_F32</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">uiA</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">uiB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">    </span><span class="n">ui32_f32</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uiA</span><span class="p">;</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="n">b</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uiB</span><span class="p">;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">signA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">sign</span><span class="p">;</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">signB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">sign</span><span class="p">;</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">signZ</span><span class="p">;</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">expA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">exponent</span><span class="p">;</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">expB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">exponent</span><span class="p">;</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">expZ</span><span class="p">;</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sigA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">frac</span><span class="p">;</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sigB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">frac</span><span class="p">;</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sigX</span><span class="p">,</span><span class="w"> </span><span class="n">sigY</span><span class="p">,</span><span class="w"> </span><span class="n">sigZ</span><span class="p">;</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15"></a>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">    </span><span class="kt">int8_t</span><span class="w"> </span><span class="n">shiftDist</span><span class="p">;</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">expDiff</span><span class="p">;</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">sigDiff</span><span class="p">;</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">uiZ</span><span class="p">;</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20"></a>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="w">    </span><span class="cm">/* main part */</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="w">    </span><span class="n">expDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">expB</span><span class="p">;</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">expDiff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="w">        </span><span class="cm">/* expA == expB */</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="w">        </span><span class="n">sigDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sigB</span><span class="p">;</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sigDiff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="w">            </span><span class="cm">/* sigA == sigB */</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="w">            </span><span class="n">uiZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packToF32UI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">uiZ</span><span class="p">;</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">expA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="w">            </span><span class="n">expA</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="w">        </span><span class="n">signZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">sign</span><span class="p">;</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sigDiff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="w">            </span><span class="n">signZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">signZ</span><span class="p">;</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="w">            </span><span class="n">sigDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sigDiff</span><span class="p">;</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a><span class="w">        </span><span class="n">shiftDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countLeadingZeros32</span><span class="p">(</span><span class="n">sigDiff</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="w">        </span><span class="n">expZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shiftDist</span><span class="p">;</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">expZ</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="w">            </span><span class="n">shiftDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expA</span><span class="p">;</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43"></a><span class="w">            </span><span class="n">expZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45"></a><span class="w">        </span><span class="n">uiZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packToF32UI</span><span class="p">(</span><span class="n">signZ</span><span class="p">,</span><span class="w"> </span><span class="n">expZ</span><span class="p">,</span><span class="w"> </span><span class="n">sigDiff</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">shiftDist</span><span class="p">);</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">uiZ</span><span class="p">;</span>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48"></a><span class="w">        </span><span class="n">signZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">sign</span><span class="p">;</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49"></a><span class="w">        </span><span class="n">sigA</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="c1">// keep 7 extra-bits</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50"></a><span class="w">        </span><span class="n">sigB</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">expDiff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52"></a><span class="w">            </span><span class="cm">/* expA &lt; expB */</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53"></a><span class="w">            </span><span class="n">signZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">signZ</span><span class="p">;</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54"></a><span class="w">            </span><span class="n">expZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expB</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55"></a><span class="w">            </span><span class="n">sigX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x40000000</span><span class="p">;</span>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56"></a><span class="w">            </span><span class="n">sigY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">expA</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0x40000000</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sigA</span><span class="p">);</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57"></a><span class="w">            </span><span class="n">expDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">expDiff</span><span class="p">;</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59"></a><span class="w">            </span><span class="cm">/* expA &gt; expB */</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60"></a><span class="w">            </span><span class="n">expZ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61"></a><span class="w">            </span><span class="n">sigX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigA</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x40000000</span><span class="p">;</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62"></a><span class="w">            </span><span class="n">sigY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigB</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">expB</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0x40000000</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sigB</span><span class="p">);</span>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">normRoundPackToF32</span><span class="p">(</span><span class="n">signZ</span><span class="p">,</span><span class="w"> </span><span class="n">expZ</span><span class="p">,</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65"></a><span class="w">                                  </span><span class="n">sigX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shiftRightJam32</span><span class="p">(</span><span class="n">sigY</span><span class="p">,</span><span class="w"> </span><span class="n">expDiff</span><span class="p">));</span>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67"></a><span class="nl">uiZ</span><span class="p">:</span>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68"></a><span class="w">    </span><span class="n">z</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uiZ</span><span class="p">;</span>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">f32</span><span class="p">;</span>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>最後，根據我們最一開始的討論，對於浮點數加減法這兩種運算，我們實際上都可以轉換成 Magnitude 相加或相減的問題。
在 Berkeley SoftFloat 的實作中，採用的方式是將 Leading-one 對齊（align）到第 31 個 bit，所以會多出 7 個 extra-bit。</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Actual API for users (add, sub, neg and abs)</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kt">float</span><span class="w"> </span><span class="nf">f32_add</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">    </span><span class="n">ui32_f32</span><span class="w"> </span><span class="n">uA</span><span class="p">,</span><span class="w"> </span><span class="n">uB</span><span class="p">;</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">magsFuncPtr</span><span class="p">)(</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="p">);</span><span class="w"> </span><span class="c1">// function ptr</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="n">uA</span><span class="p">.</span><span class="n">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">uB</span><span class="p">.</span><span class="n">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">    </span><span class="n">magsFuncPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uA</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">sign</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">uB</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">sign</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subMag_F32</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">addMag_F32</span><span class="p">;</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">magsFuncPtr</span><span class="p">(</span><span class="n">uA</span><span class="p">.</span><span class="n">ui32</span><span class="p">,</span><span class="w"> </span><span class="n">uB</span><span class="p">.</span><span class="n">ui32</span><span class="p">);</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="p">}</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="kt">float</span><span class="w"> </span><span class="nf">f32_sub</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">f32_add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">f32_neg</span><span class="p">(</span><span class="n">b</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="kt">float</span><span class="w"> </span><span class="nf">f32_neg</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">    </span><span class="n">ui32_f32</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">    </span><span class="n">ret</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">;</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">f32</span><span class="p">;</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="p">}</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="kt">float</span><span class="w"> </span><span class="nf">f32_abs</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="w">    </span><span class="n">ui32_f32</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">    </span><span class="n">ret</span><span class="p">.</span><span class="n">ui32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7fffffff</span><span class="p">;</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">.</span><span class="n">f32</span><span class="p">;</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>最後，我們可以看到在 <code>f32_add</code> 這個函式中，利用了一個 Function Pointer <code>magsFuncPtr</code> 配合 a 和 b 的 sign-bit 來判斷要呼叫 <code>addMag_F32</code> 還是 <code>subMag_F32</code>。</p>
<div class="admonition note">
<p class="admonition-title">Big-Endian &amp; Little-Endian 對 Floating-Point Negation 實作上的影響</p>
<p><strong>參考：<a href="https://hackmd.io/@NwaynhhKTK6joWHmoUxc7Q/H1SVhbETQ?type=view">浮點數運算和定點數操作</a></strong></p>
<p>從前面的程式碼可以看到，我們利用了 C 語言中的 Bit-Field 技巧來更方便地取出 Sign、Exponent 和 Fraction。但是，Bit-Field 的順序其實會受到 Endianness 的影響。
如果是 Big-Endian 的架構，我們目前所定義的 Bit-Field 的順序就必須顛倒過來，變成先宣告 Fraction、再宣告 Exponent 和 Sign。</p>
</div>
<h2 id="chapter-3-how-to-compile-and-run-the-demo">Chapter 3. How to Compile and Run The Demo<a class="headerlink" href="#chapter-3-how-to-compile-and-run-the-demo" title="Permanent link">&para;</a></h2>
<p>為了同時操是我們實作的 I/O Library 和 Floating-Point Emulation Library，我們可以利用一個非常有趣的程式來測試，這個程式的用途是利用 ASCII Code 畫出非常名的碎形 Mandelbrot Set。</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Draw Mandelbrot Set with ASCII</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;../lib/include/io.h&quot;</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;../lib/include/fp.h&quot;</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32_add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mf">0.06</span><span class="p">),</span><span class="w"> </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32_add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="mf">0.03</span><span class="p">),</span><span class="w"> </span><span class="n">putchar</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">31</span><span class="p">))</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">f32_add</span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">                 </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32_add</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32_add</span><span class="p">(</span><span class="n">f32_sub</span><span class="p">(</span><span class="n">R</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">),</span><span class="w"> </span><span class="n">r</span><span class="p">))</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">                </span><span class="p">;</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>受限於我們只有實作浮點數的加減法運算的模擬，但是繪製 Mandelbrot Set 會需要用到浮點數的乘法運算還有比較運算，所以我們還是必須要使用 Libgcc 來彌補我們實作上的不足，才能使這個程式在我們的 ISS 上執行。</p>
<p>執行後預期會看到以下輸出：</p>
<figure>
  <img alt="" src="../img/lab-3/mandelbrot.png" width="850" />
</figure>
<p>如同 Lab 2，只要輸入 <code>make</code> 就可以執行編譯，所有編譯過程中產生的檔案和最終的執行檔（ELF）都會被放在 <code>build/</code> 資料夾底下。</p>
<h2 id="chapter-4-start-to-do-the-assignment">Chapter 4. Start to Do The Assignment<a class="headerlink" href="#chapter-4-start-to-do-the-assignment" title="Permanent link">&para;</a></h2>
<h3 id="41-assignment-requirement">4.1 Assignment Requirement<a class="headerlink" href="#41-assignment-requirement" title="Permanent link">&para;</a></h3>
<ol>
<li>完成 <code>printf</code> 的實作，並且將 Mandelbrot Set 程式中的 <code>puts</code> 和 <code>putchar</code> 替換成 printf。</li>
<li>完成 Assignment Report，並且回答 Report 中的提問</li>
</ol>
<h3 id="42-notes">4.2 Notes<a class="headerlink" href="#42-notes" title="Permanent link">&para;</a></h3>
<ol>
<li>Clone the sample code<ul>
<li>先確定自己已經打開課程開發環境（Container），並且在環境中的 <code>workspace</code> 底下</li>
<li>下載助教提供的 Sample Code<blockquote>
<p><code>git clone https://gitlab.course.aislab.ee.ncku.edu.tw/113-1/lab-3.git</code></p>
</blockquote>
</li>
<li>進入資料夾<blockquote>
<p><code>cd lab-3</code></p>
</blockquote>
</li>
</ul>
</li>
<li>Create a private repo<ul>
<li>如同 Lab 1 所述，在 Gitlab 上面創建個人 Repo，並且命名為 <code>Lab 3</code>，請不要勾選 <em>Initialize the repository with README</em></li>
<li>確認 branch 的名稱為 main 而非 master<blockquote>
<p><code>git branch -M main</code></p>
</blockquote>
</li>
<li>新增自己的 Private Gitlab Repo 為 Remote Source<blockquote>
<p><code>git remote add private &lt;HTTPS URL of your private repo&gt;</code></p>
</blockquote>
</li>
</ul>
</li>
<li>將程式碼 Push 你的 Private Repository<ul>
<li>請記得是推到 <code>private</code> 而非 <code>origin</code><blockquote>
<p><code>git push -u private main</code></p>
</blockquote>
</li>
</ul>
</li>
<li>Notes<ul>
<li>因為在<strong>預設</strong>情況之下，只要 Gitlab Repo 中包含 <code>.gitlab-ci.yml</code> 檔案就會觸發 CI/CD Pipeline，如果你在前期尚未完成作業的時候不想觸發 Pipeline，可以先在 Gitlab 你的 Private Repo 中的設定將 CI/CD 功能關閉，待完成作業之後再打開</li>
</ul>
</li>
<li><strong>請記得依據 <a href="https://hedgedoc.course.aislab.ee.ncku.edu.tw/8lYdKxG9R1GsVWB7_MwsgA?view">Assignment Report Template</a> 撰寫本次作業的報告，並且繳交報告連結到成大 Moodle 作業繳交區上</strong></li>
</ol>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>這裡的課本指的是：<em>Computer Organization and Design RISC-V Edition: The Hardware/Software Interface</em>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a><a class="footnote-backref" href="#fnref2:1" title="Jump back to footnote 1 in the text">&#8617;</a><a class="footnote-backref" href="#fnref3:1" title="Jump back to footnote 1 in the text">&#8617;</a><a class="footnote-backref" href="#fnref4:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; Create by <a href=""  target="_blank" rel="noopener">Jieum.C</a> in 2024 ♥ 

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.instagram.com/eemomolleyball?igsh=MnI5cnM0YnljcnEy" target="_blank" rel="noopener" title="www.instagram.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141m0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7m146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8m76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8M398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.top", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.path", "toc.integrate", "toc.follow", "search.suggest", "search.highlight", "search.relevance", "content.tabs", "content.code.annotation", "content.code.copy", "content.footnotes", "content.images"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../js/custom.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
      
        <script src="../../js/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>